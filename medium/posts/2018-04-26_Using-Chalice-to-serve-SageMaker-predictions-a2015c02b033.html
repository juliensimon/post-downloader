<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Using Chalice to serve SageMaker predictions</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Using Chalice to serve SageMaker predictions</h1>
</header>
<section data-field="subtitle" class="p-summary">
Amazon SageMaker makes it easy to train and deploy Machine Learning models hosted on HTTP endpoints. However, in most cases you won’t…
</section>
<section data-field="body" class="e-content">
<section name="fedd" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="8e8f" id="8e8f" class="graf graf--h3 graf--leading graf--title">Using Chalice to serve SageMaker predictions</h3><p name="e418" id="e418" class="graf graf--p graf-after--h3"><a href="https://aws.amazon.com/sagemaker" data-href="https://aws.amazon.com/sagemaker" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><strong class="markup--strong markup--p-strong">Amazon SageMaker</strong></a> makes it easy to train and deploy Machine Learning models hosted on HTTP endpoints. However, in most cases you won’t expose these endpoints directly. <strong class="markup--strong markup--p-strong">Pre-processing </strong>and<strong class="markup--strong markup--p-strong"> post-processing steps</strong> are likely to be required: authentication, throttling, data transformation and enrichment, logging, etc.</p><p name="32a4" id="32a4" class="graf graf--p graf-after--p">In this post, we will use <a href="https://github.com/aws/chalice" data-href="https://github.com/aws/chalice" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><strong class="markup--strong markup--p-strong">AWS Chalice</strong></a> to build a <strong class="markup--strong markup--p-strong">web service acting as a front-end for a SageMaker endpoint</strong>.</p><p name="4f2e" id="4f2e" class="graf graf--p graf-after--p">Let’s get started.</p><figure name="bd1a" id="bd1a" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="0*5KvSy7pLEpPmARI8." data-width="625" data-height="345" src="https://cdn-images-1.medium.com/max/800/0*5KvSy7pLEpPmARI8."><figcaption class="imageCaption">Oh, you’re the front-end service, I suppose.</figcaption></figure><h4 name="c43d" id="c43d" class="graf graf--h4 graf-after--figure">Training and deploying our SageMaker model</h4><p name="1bdb" id="1bdb" class="graf graf--p graf-after--h4">I’ve already written a couple of posts (<a href="https://medium.com/@julsimon/building-a-movie-recommender-with-factorization-machines-on-amazon-sagemaker-cedbfc8c93d8" data-href="https://medium.com/@julsimon/building-a-movie-recommender-with-factorization-machines-on-amazon-sagemaker-cedbfc8c93d8" class="markup--anchor markup--p-anchor" target="_blank">here</a> and <a href="https://medium.com/@julsimon/image-classification-on-amazon-sagemaker-9b66193c8b54" data-href="https://medium.com/@julsimon/image-classification-on-amazon-sagemaker-9b66193c8b54" class="markup--anchor markup--p-anchor" target="_blank">here</a>) on training and deploying SageMaker models, so I won’t go into these details again. For our purpose, we’ll use the <strong class="markup--strong markup--p-strong">built-in algorithm for image classification</strong> to train a model on the <a href="https://authors.library.caltech.edu/7694/" data-href="https://authors.library.caltech.edu/7694/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><strong class="markup--strong markup--p-strong">Caltech-256</strong></a> data set, as presented in this <a href="https://github.com/awslabs/amazon-sagemaker-examples/blob/master/introduction_to_amazon_algorithms/imageclassification_caltech/Image-classification-transfer-learning.ipynb" data-href="https://github.com/awslabs/amazon-sagemaker-examples/blob/master/introduction_to_amazon_algorithms/imageclassification_caltech/Image-classification-transfer-learning.ipynb" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><strong class="markup--strong markup--p-strong">tutorial</strong></a>.</p><p name="3ba6" id="3ba6" class="graf graf--p graf-after--p">Once training and deployment are complete, the endpoint is ready for prediction.</p><figure name="ca32" id="ca32" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/juliensimon/df5b4102c719db18d82724fbc3e2a7a9.js"></script></figure><h4 name="691d" id="691d" class="graf graf--h4 graf-after--figure">Invoking a SageMaker model</h4><p name="4700" id="4700" class="graf graf--p graf-after--h4">First, we need to figure out what data format the algo expects: as explained in the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/image-classification.html" data-href="https://docs.aws.amazon.com/sagemaker/latest/dg/image-classification.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">documentation</a>, we need to post <strong class="markup--strong markup--p-strong">binary data with the <em class="markup--em markup--p-em">application/x-image</em> content type</strong>.</p><p name="5bbc" id="5bbc" class="graf graf--p graf-after--p">We’ll do this with the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/API_runtime_InvokeEndpoint.html" data-href="https://docs.aws.amazon.com/sagemaker/latest/dg/API_runtime_InvokeEndpoint.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">InvokeEndpoint</em></strong></a> API, which you’ll find it in your favourite AWS SDK: we simply need to provide an <strong class="markup--strong markup--p-strong">endpoint name</strong> and of course the <strong class="markup--strong markup--p-strong">body</strong>.</p><blockquote name="bd07" id="bd07" class="graf graf--blockquote graf-after--p">AWS CLI users: don’t be confused if you don’t see it InvokeEndpoint in the list of SageMaker APIs: it’s in ‘sagemaker-runtime’, not in ‘sagemaker’</blockquote><p name="3c11" id="3c11" class="graf graf--p graf-after--blockquote">Here’s an example with <a href="https://github.com/boto/boto3" data-href="https://github.com/boto/boto3" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><strong class="markup--strong markup--p-strong">boto3</strong></a>.</p><figure name="161a" id="161a" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/juliensimon/41d6348bdd1eac956b35feafbc638347.js"></script></figure><pre name="ad26" id="ad26" class="graf graf--pre graf-after--figure">$ python invoke.py<br>b&#39;[1.4174277566780802e-05, 1.6996695194393396e-05, 0.00011234339035581797, 0.0002156866539735347, 3.110157194896601e-05, 0.00025752029614523053, 2.8299189580138773e-05, 0.00012142073683207855, 9.117752779275179e-05, 4.787529178429395e-05, 3.5472228773869574e-05, 0.00019932845316361636, 5.5317421356448904e-05, 6.963817668292904e-06, 4.422592246555723e-05, 9.264561231248081e-05, 2.4938033675425686e-05, 0.0002587089838925749, 0.00026409601559862494, 1.0121700142917689e-05, 0.0038431661669164896, 2.7548372599994764e-05, 3.41928462148644e-05, 7.225569424917921e-05, 1.1924025784537662e-05, 7.16273789294064e-05, 0.000851281511131674, 3.8102120015537366e-05, 8.411310773226433e-06, [output removed]</pre><p name="0145" id="0145" class="graf graf--p graf-after--pre">OK, this worked. The response contains <strong class="markup--strong markup--p-strong">257 probabilities</strong>, <strong class="markup--strong markup--p-strong">one for each of the CalTech-256 categories</strong> (256 object categories plus a catch-all category). As our image represents a floppy disk (category #75), the highest probability is the 74th one. You can check if you feel like it :)</p><p name="51e7" id="51e7" class="graf graf--p graf-after--p">Now, it’s time to write a <strong class="markup--strong markup--p-strong">front-end web service</strong> for this endpoint.</p><h4 name="966f" id="966f" class="graf graf--h4 graf-after--p">A quick recap on Chalice</h4><p name="60ce" id="60ce" class="graf graf--p graf-after--h4">Chalice is an <strong class="markup--strong markup--p-strong">AWS Open Source project</strong> that lets developers build <strong class="markup--strong markup--p-strong">Python-based web services</strong> with minimal fuss. The programming model is extremely close to <a href="http://flask.pocoo.org/" data-href="http://flask.pocoo.org/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><strong class="markup--strong markup--p-strong">Flask</strong></a>, so you should feel right at home. Installation is a breeze (<em class="markup--em markup--p-em">pip install chalice</em>) and the CLI is idiot-proof (*I* can use it).</p><p name="9157" id="9157" class="graf graf--p graf-after--p">Simple services require <strong class="markup--strong markup--p-strong">very little configuration</strong>, if any. Based on the boto3 calls in your code, <strong class="markup--strong markup--p-strong">Chalice generates an IAM policy</strong> which will be attached to the Lambda function’s role. You’ll generally want to tweak it a bit, but it’s a nice starting point and a <strong class="markup--strong markup--p-strong">great time save</strong>r. You can also bring <strong class="markup--strong markup--p-strong">your own policy </strong>(which we’ll do later on).</p><p name="8458" id="8458" class="graf graf--p graf-after--p">You can add <strong class="markup--strong markup--p-strong">Python dependencies</strong> by listing them in the <strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">requirements.txt</em></strong> file. Just remember that Lambda functions can’t exceed a zipped size of 50MB, so you should be conservative!</p><p name="37c8" id="37c8" class="graf graf--p graf-after--p">When it comes to deployment (‘<em class="markup--em markup--p-em">chalice deploy</em>’), <strong class="markup--strong markup--p-strong">Chalice automatically creates a Lambda function running your code, as well as an API in the API Gateway to trigger it</strong>. If you’d rather deploy with <a href="https://github.com/awslabs/serverless-application-model" data-href="https://github.com/awslabs/serverless-application-model" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><strong class="markup--strong markup--p-strong">SAM</strong></a>, that’s possible too: ‘<em class="markup--em markup--p-em">chalice package</em>’ will build both the deployment package and the SAM template.</p><p name="20c8" id="20c8" class="graf graf--p graf-after--p">Last but not least, you can <strong class="markup--strong markup--p-strong">run your service locally</strong> (‘<em class="markup--em markup--p-em">chalice local</em>’) which obviously helps debugging.. and allows you to code on planes ;)</p><p name="5062" id="5062" class="graf graf--p graf-after--p">Alright, let’s get to it.</p><h4 name="7929" id="7929" class="graf graf--h4 graf-after--p">Writing an image prediction service with chalice</h4><p name="6776" id="6776" class="graf graf--p graf-after--h4">As we just saw, the endpoint returns a raw prediction, which contains probably more information than we need to send back to the client. Thus, our service will <strong class="markup--strong markup--p-strong">only return the top k classes and probabilities, in descending order of probability</strong>.</p><p name="b286" id="b286" class="graf graf--p graf-after--p">The <strong class="markup--strong markup--p-strong">body</strong> of our POST request will contain:</p><ul class="postList"><li name="19a5" id="19a5" class="graf graf--li graf-after--p">a mandatory <strong class="markup--strong markup--li-strong">base64-encoded image</strong>,</li><li name="a22a" id="a22a" class="graf graf--li graf-after--li">an optional <strong class="markup--strong markup--li-strong">value for ‘k’</strong>. If it’s missing, the service will use the default value of 257.</li></ul><p name="f870" id="f870" class="graf graf--p graf-after--li">For more flexibility, let’s store the SageMaker <strong class="markup--strong markup--p-strong">endpoint name</strong> in an <strong class="markup--strong markup--p-strong">environment variable</strong> for the Lambda function.</p><p name="bafd" id="bafd" class="graf graf--p graf-after--p">Here are the steps we need to take:</p><ul class="postList"><li name="a8bd" id="a8bd" class="graf graf--li graf-after--p">decode the base64-encoded image,</li><li name="5540" id="5540" class="graf graf--li graf-after--li">read the endpoint name from an environment variable,</li><li name="195c" id="195c" class="graf graf--li graf-after--li">invoke the endpoint using the InvokeEndpoint API in boto3,</li><li name="1b6b" id="1b6b" class="graf graf--li graf-after--li">read the response,</li><li name="b94e" id="b94e" class="graf graf--li graf-after--li">sort categories by descending order of probability,</li><li name="f4d9" id="f4d9" class="graf graf--li graf-after--li">return only the top k categories and probabilities.</li></ul><p name="e280" id="e280" class="graf graf--p graf-after--li">Pretty straightforward, I think. Most of the work is actually to <strong class="markup--strong markup--p-strong">convert response data</strong> into something that we process. Indeed, the response body is a byte array representing a bracketed array of comma-separated probabilities, which is inconvenient to work with.</p><p name="1a36" id="1a36" class="graf graf--p graf-after--p">In order to turn it into a proper Python array, we can evaluate it as a Python expression with <em class="markup--em markup--p-em">ast.literal_eval()</em>. And voila: a Python array! Nice trick.</p><p name="97df" id="97df" class="graf graf--p graf-after--p">We can then build a <a href="http://www.numpy.org/" data-href="http://www.numpy.org/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><strong class="markup--strong markup--p-strong">Numpy</strong></a> array holding the <strong class="markup--strong markup--p-strong">category indexes</strong> in ascending order of probability, reverse the array and take the first top k elements. The last step is to build the response body.</p><figure name="53e8" id="53e8" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/juliensimon/c2d9441bf3febdcd9ee4d86d6f25a5a2.js"></script></figure><p name="268c" id="268c" class="graf graf--p graf-after--figure">Pfeew. That was a little more Python plumbing than I originally expected, but it’s actually a good example of <strong class="markup--strong markup--p-strong">post-processing raw predictions</strong>.</p><h4 name="6d37" id="6d37" class="graf graf--h4 graf-after--p">Configuring the service</h4><p name="290b" id="290b" class="graf graf--p graf-after--h4">Configuration is pretty simple and is stored in <em class="markup--em markup--p-em">.chalice/config.json:</em></p><ul class="postList"><li name="7896" id="7896" class="graf graf--li graf-after--p">an <strong class="markup--strong markup--li-strong">environment variable</strong> to store the endpoint name,</li><li name="ee1f" id="ee1f" class="graf graf--li graf-after--li">a <strong class="markup--strong markup--li-strong">custom IAM policy</strong>, allowing the Lambda function to call the InvokeEndpoint API. Once again, we could let Chalice generate it for us, but it’s good to know how to customize your policy :)</li></ul><figure name="fbf9" id="fbf9" class="graf graf--figure graf--iframe graf-after--li"><script src="https://gist.github.com/juliensimon/032fdc607fdccf47be02b732db399962.js"></script><figcaption class="imageCaption">Configuration file</figcaption></figure><figure name="9a8e" id="9a8e" class="graf graf--figure graf--iframe graf-after--figure"><script src="https://gist.github.com/juliensimon/f1eec360bbe6e5eb123c36903b19ebc4.js"></script><figcaption class="imageCaption">IAM policy</figcaption></figure><p name="b4fc" id="b4fc" class="graf graf--p graf-after--figure">Using ‘*’ as a resource selector for <em class="markup--em markup--p-em">InvokeEndpoint</em> is ok here. However, in production, I would strongly recommend using the <strong class="markup--strong markup--p-strong">actual endpoint ARN</strong> instead.</p><h4 name="0618" id="0618" class="graf graf--h4 graf-after--p">Running the service locally</h4><p name="26ff" id="26ff" class="graf graf--p graf-after--h4">Let’s test the service locally by running ‘<em class="markup--em markup--p-em">chalice local</em>’ and then<em class="markup--em markup--p-em"> curl</em> to invoke it.</p><figure name="f1ad" id="f1ad" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/juliensimon/97056d600c74054737806d6470b9914b.js"></script></figure><p name="d94a" id="d94a" class="graf graf--p graf-after--figure">Nice. Our service seems to work :)</p><h4 name="4b8c" id="4b8c" class="graf graf--h4 graf-after--p">Deploying the service</h4><p name="921a" id="921a" class="graf graf--p graf-after--h4">Now it’s time to deploy on AWS by running ‘<em class="markup--em markup--p-em">chalice deploy</em>’. Let’s run the same test.</p><figure name="4842" id="4842" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/juliensimon/7b9682b8f7375e5e8abb47d19a484e26.js"></script></figure><p name="428e" id="428e" class="graf graf--p graf-after--figure">All good. That’s it, then: <strong class="markup--strong markup--p-strong">we successfully built a serverless microservice invoking a SageMaker endpoint</strong> (<a href="https://github.com/juliensimon/aws/tree/master/lambda_frameworks/chalice/predictor" data-href="https://github.com/juliensimon/aws/tree/master/lambda_frameworks/chalice/predictor" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">code and test script on Github</a>).</p><p name="19c3" id="19c3" class="graf graf--p graf-after--p">This is pretty fun, so why not write another service?</p><h4 name="bb89" id="bb89" class="graf graf--h4 graf-after--p">Bonus: an image resizer service with Chalice</h4><p name="421c" id="421c" class="graf graf--p graf-after--h4">Computer vision models require <strong class="markup--strong markup--p-strong">input images to have the same size as training images</strong>. I believe the SageMaker built-in algorithm handles image resizing for us, but it’s definitely something we’d have to take care of if we worked with your own custom model.</p><p name="ab6e" id="ab6e" class="graf graf--p graf-after--p">Here’s how you could do this with the <a href="https://opencv.org/" data-href="https://opencv.org/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><strong class="markup--strong markup--p-strong">OpenCV</strong></a> library (<a href="https://github.com/juliensimon/aws/tree/master/lambda_frameworks/chalice/resizer" data-href="https://github.com/juliensimon/aws/tree/master/lambda_frameworks/chalice/resizer" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">code and test script on Github</a>).</p><figure name="c51a" id="c51a" class="graf graf--figure graf--iframe graf-after--p graf--trailing"><script src="https://gist.github.com/juliensimon/413e9ec9923ef29766306e4a83bef23a.js"></script></figure></div></div></section><section name="47a4" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="f81f" id="f81f" class="graf graf--p graf--leading">That’s it for today. As you can see, <strong class="markup--strong markup--p-strong">it’s quite simple to invoke SageMaker endpoints. If you want to go all the way and build a web service, then Chalice is certainly an option you should consider</strong>. I can’t think of an easier way to do it!</p><p name="0847" id="0847" class="graf graf--p graf-after--p graf--trailing">Thanks for reading. Happy to get your feedback and answer your questions here or on <a href="https://twitter.com/julsimon" data-href="https://twitter.com/julsimon" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Twitter</a>.</p></div></div></section><section name="dfca" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="cdc0" id="cdc0" class="graf graf--p graf--leading"><em class="markup--em markup--p-em">Bay Area Thrash Metal, 1988. This A bit of trivia: Paul Bostaph on drums… now in Slayer \m/</em></p><figure name="e48d" id="e48d" class="graf graf--figure graf--iframe graf-after--p graf--trailing"><iframe src="https://www.youtube.com/embed/0pTRdopfq1g?feature=oembed" width="640" height="480" frameborder="0" scrolling="no"></iframe></figure></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@julsimon" class="p-author h-card">Julien Simon</a> on <a href="https://medium.com/p/a2015c02b033"><time class="dt-published" datetime="2018-04-26T22:18:37.055Z">April 26, 2018</time></a>.</p><p><a href="https://medium.com/@julsimon/using-chalice-to-serve-sagemaker-predictions-a2015c02b033" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on July 26, 2025.</p></footer></article></body></html>
