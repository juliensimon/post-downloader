<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>ImageNet — part 1: going on an adventure</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">ImageNet — part 1: going on an adventure</h1>
</header>
<section data-field="subtitle" class="p-summary">
When it comes to building image classifiers, ImageNet is probably the most well known data set. It’s also used for the annual ILSVRC…
</section>
<section data-field="body" class="e-content">
<section name="ddda" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="cf22" id="cf22" class="graf graf--h3 graf--leading graf--title">ImageNet — part 1: going on an adventure</h3><p name="6dd6" id="6dd6" class="graf graf--p graf-after--h3">When it comes to building image classifiers, <a href="http://www.image-net.org/" data-href="http://www.image-net.org/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">ImageNet</a> is probably the most well known data set. It’s also used for the annual <a href="http://www.image-net.org/challenges/LSVRC/" data-href="http://www.image-net.org/challenges/LSVRC/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">ILSVRC</a> competition, where researchers from all over the world compete to build the most efficient models.</p><p name="99ea" id="99ea" class="graf graf--p graf-after--p">As <a href="https://becominghuman.ai/training-mxnet-part-2-cifar-10-c7b0b729c33c" data-href="https://becominghuman.ai/training-mxnet-part-2-cifar-10-c7b0b729c33c" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">previously discussed</a>, models are frequently trained on ImageNet before being fine-tuned on other image sets. Fine-tuning is a much faster process and a great way to get very good accuracy in just a few epochs.</p><p name="1314" id="1314" class="graf graf--p graf-after--p">Still, what does it take to actually grab ImageNet and prepare it for training. Let’s find out. We’ll start with <a href="http://mxnet.io" data-href="http://mxnet.io" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Apache MXNet</a>, but who knows where we’ll end up?</p><figure name="2b84" id="2b84" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*CvHQyBb28ThV5z18CJhcQw.jpeg" data-width="600" data-height="301" src="https://cdn-images-1.medium.com/max/800/1*CvHQyBb28ThV5z18CJhcQw.jpeg"><figcaption class="imageCaption">You do know that there is a dragon under that mountain, don’t you?</figcaption></figure><h4 name="9bef" id="9bef" class="graf graf--h4 graf-after--figure">ImageNet in numbers</h4><p name="6a29" id="6a29" class="graf graf--p graf-after--h4">Clocking in at <strong class="markup--strong markup--p-strong">150 GB</strong>, ImageNet is quite a beast. It holds <strong class="markup--strong markup--p-strong">1,281,167 images</strong> for training and 50,000 images for validation, organised in <strong class="markup--strong markup--p-strong">1,000 categories</strong>. We’re pretty far from <a href="http://yann.lecun.com/exdb/mnist/" data-href="http://yann.lecun.com/exdb/mnist/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">MNIST</a> or <a href="https://www.cs.toronto.edu/~kriz/cifar.html" data-href="https://www.cs.toronto.edu/~kriz/cifar.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">CIFAR-10</a>!</p><p name="83f3" id="83f3" class="graf graf--p graf-after--p">This creates all kinds of interesting problems that need to be solved before training even starts, namely:</p><ul class="postList"><li name="2c0a" id="2c0a" class="graf graf--li graf-after--p">Downloading the data set,</li><li name="de29" id="de29" class="graf graf--li graf-after--li">Organising the data set for training,</li><li name="c9fc" id="c9fc" class="graf graf--li graf-after--li">Creating RecordIO files to optimize I/O,</li><li name="d6eb" id="d6eb" class="graf graf--li graf-after--li">Backing up the data set, because who wants to download 150GB again?</li><li name="cbdd" id="cbdd" class="graf graf--li graf-after--li">Deploying the data set efficiently to GPU instances for training,</li></ul><p name="5980" id="5980" class="graf graf--p graf-after--li">We’re going to look at all these steps. As always, the devil is in the details.</p><h4 name="c9c2" id="c9c2" class="graf graf--h4 graf-after--p">Starting up a download instance</h4><p name="d737" id="d737" class="graf graf--p graf-after--h4">We need to download 150GB. That’s gonna take a while (think days) and it’s gonna fill, well, just about 150GB of disk space. So you’d better plan ahead.</p><p name="c753" id="c753" class="graf graf--p graf-after--p">Here’s how I did it: I started a <em class="markup--em markup--p-em">t2.large</em> instance (but <em class="markup--em markup--p-em">t2.micro</em> should work too), which is more than powerful enough to handle the download. I also attached a 1000GB <a href="https://aws.amazon.com/ebs/" data-href="https://aws.amazon.com/ebs/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><strong class="markup--strong markup--p-strong">EBS</strong></a> volume to it (because we’ll need additional space later on). As I/O performance is not important here, I picked the least expensive <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSVolumeTypes.html" data-href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSVolumeTypes.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">volume type</a> (<em class="markup--em markup--p-em">sc1</em>).</p><p name="ea78" id="ea78" class="graf graf--p graf-after--p">Then I <em class="markup--em markup--p-em">ssh</em>’ed into the instance, formatted the volume, mounted it on <em class="markup--em markup--p-em">/data</em> and <em class="markup--em markup--p-em">chown</em>’ed it recursively to <em class="markup--em markup--p-em">ec2-user:ec2-user</em>. I hope you don’t need me to show you these steps, but here’s the <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-using-volumes.html" data-href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-using-volumes.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">tutorial</a>, just in case ;)</p><h4 name="acef" id="acef" class="graf graf--h4 graf-after--p">Downloading the data set</h4><p name="0eee" id="0eee" class="graf graf--p graf-after--h4">It starts easy. Head out to the <a href="http://www.image-net.org/" data-href="http://www.image-net.org/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">ImageNet</a> website, register, accept conditions and voila. You’ll get a <strong class="markup--strong markup--p-strong">username</strong> and an <strong class="markup--strong markup--p-strong">access key</strong> which will let you download the data set, which is composed of several very large files: no way we can right click and “save as”.</p><p name="b9fb" id="b9fb" class="graf graf--p graf-after--p">Fortunately, one of the Tensorflow <a href="https://github.com/tensorflow/models/" data-href="https://github.com/tensorflow/models/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">repositories</a> includes a nice <strong class="markup--strong markup--p-strong">download script</strong>, <a href="https://github.com/tensorflow/models/tree/master/research/inception/inception/data/download_imagenet.sh" data-href="https://github.com/tensorflow/models/tree/master/research/inception/inception/data/download_imagenet.sh" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><em class="markup--em markup--p-em">download_imagenet.sh</em></a>. It’s quite straightforward, this is how to use it.</p><figure name="0123" id="0123" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/juliensimon/ac77f37dcbcfb9442725cd7ac390c4e9.js"></script></figure><p name="0719" id="0719" class="graf graf--p graf-after--figure">And then, you have to wait for a bit: my download took about <strong class="markup--strong markup--p-strong">5 days</strong>…</p><p name="ba98" id="ba98" class="graf graf--p graf-after--p">Once the script has completed, your directory should look like this.</p><figure name="4f6b" id="4f6b" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/juliensimon/d43955c25e7754be743bf3e98b22fa08.js"></script></figure><h4 name="8245" id="8245" class="graf graf--h4 graf-after--figure">Organising the data set for training</h4><p name="c245" id="c245" class="graf graf--p graf-after--h4">Let’s take a look at the data set. If you list the <em class="markup--em markup--p-em">imagenet/train</em> directory, you’ll see <strong class="markup--strong markup--p-strong">1,000 directories</strong>, each of them holding images for a given ImageNet category. Yes, they have weird names, which is why you need to grab <a href="https://github.com/juliensimon/aws/blob/master/mxnet/imagenet/synsets_with_descriptions.txt" data-href="https://github.com/juliensimon/aws/blob/master/mxnet/imagenet/synsets_with_descriptions.txt" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">this file</a> to know what’s what, e.g. <em class="markup--em markup--p-em">n02510455</em> is the category for giant pandas.</p><p name="a3a0" id="a3a0" class="graf graf--p graf-after--p">If you list the <em class="markup--em markup--p-em">imagenet/validation</em> directory, you see 50,000 images in a <strong class="markup--strong markup--p-strong">single directory</strong>. That’s not really practical, we’d like to have them in 1,000 directories as well. <a href="https://github.com/juliensimon/aws/blob/master/mxnet/imagenet/build_validation_tree.sh" data-href="https://github.com/juliensimon/aws/blob/master/mxnet/imagenet/build_validation_tree.sh" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">This script</a> will take care of it: simply run it inside the <em class="markup--em markup--p-em">validation</em> directory.</p><h4 name="8fdf" id="8fdf" class="graf graf--h4 graf-after--p">Creating RecordIO files to optimize I/O</h4><p name="7c91" id="7c91" class="graf graf--p graf-after--h4">During training, we could definitely load images from disk. However, this would require <strong class="markup--strong markup--p-strong">a lot of I/O</strong>, especially when using multiple GPUs: these beasts are very hungry and you need to keep feeding them with data at the proper throughout. Failing to do so will <strong class="markup--strong markup--p-strong">stall</strong> the GPUs and your training speed will drop (more on this in a future post).</p><p name="7bf9" id="7bf9" class="graf graf--p graf-after--p">Another problem arises when distributed training is used, i.e. when multiple GPU instances are learning the same data set. Sure, we could copy the full data set to each instance, but that may be impractical for huge ones.</p><p name="8df5" id="8df5" class="graf graf--p graf-after--p">In order to solve both issues, we’re going to convert the data set into <a href="https://mxnet.incubator.apache.org/architecture/note_data_loading.html" data-href="https://mxnet.incubator.apache.org/architecture/note_data_loading.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><strong class="markup--strong markup--p-strong">RecordIO files</strong></a>. This compact format is both I/O efficient and easily shareable across instances.</p><p name="0773" id="0773" class="graf graf--p graf-after--p">The process is pretty simple: we’re going to <strong class="markup--strong markup--p-strong">pack</strong> the training set and the validation set in their own RecordIO file. We’re also going to <strong class="markup--strong markup--p-strong">resize</strong> and <strong class="markup--strong markup--p-strong">compress</strong> the images a bit to save some space: this won’t have any impact on training quality, since most of the ImageNet models require 224x244 images. Feel free to create plenty of threads to maximize throughput :)</p><p name="a669" id="a669" class="graf graf--p graf-after--p">Let’s start with the validation set. It only takes a couple of minutes.</p><figure name="a1ee" id="a1ee" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/juliensimon/5fce1bd30f893b944d096af672638435.js"></script></figure><p name="ccf7" id="ccf7" class="graf graf--p graf-after--figure">Now, let’s do the same thing for the training set. This is going to run for a while (about 1h30 on my <em class="markup--em markup--p-em">t2.xlarge</em>).</p><figure name="c595" id="c595" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/juliensimon/f1668ebe3f8874a46a382503256f4bac.js"></script></figure><h4 name="4038" id="4038" class="graf graf--h4 graf-after--figure">Backing up</h4><p name="71bd" id="71bd" class="graf graf--p graf-after--h4">At this point, losing all this would suck beyond belief, wouldn’t it? Let’s make sure we <strong class="markup--strong markup--p-strong">back everything up</strong> in S3. Just create a bucket and <strong class="markup--strong markup--p-strong">sync</strong> it with <em class="markup--em markup--p-em">/data</em>. Yes, that’s going to take a while.</p><figure name="9815" id="9815" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/juliensimon/3a3f92597e61268b46bc79dd1238eb2e.js"></script></figure><p name="6df2" id="6df2" class="graf graf--p graf-after--figure">Once the backup is over, you should:</p><ul class="postList"><li name="0905" id="0905" class="graf graf--li graf-after--p">terminate the download instance,</li><li name="b080" id="b080" class="graf graf--li graf-after--li">create a <strong class="markup--strong markup--li-strong">snapshot</strong> of the EBS volume: it’s another long operation but better safe than sorry, plus it’s going to help us deploy the data set to as many instances as we need, including <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-modifying-snapshot-permissions.html" data-href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-modifying-snapshot-permissions.html" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">across accounts and regions</a> if needed.</li></ul><h4 name="8201" id="8201" class="graf graf--h4 graf-after--li"><em class="markup--em markup--h4-em">Deploying the data set</em></h4><p name="7632" id="7632" class="graf graf--p graf-after--h4">Deploying the data set to a new GPU instance is now as easy as:</p><ul class="postList"><li name="b998" id="b998" class="graf graf--li graf-after--p">creating a new EBS volume from the snapshot (make sure you create it in the <strong class="markup--strong markup--li-strong">same AZ</strong> as your instance),</li><li name="ca3f" id="ca3f" class="graf graf--li graf-after--li">attaching it to the instance,</li><li name="0f3d" id="0f3d" class="graf graf--li graf-after--li">mounting the filesystem.</li></ul><p name="b0a8" id="b0a8" class="graf graf--p graf-after--li">This will only take <strong class="markup--strong markup--p-strong">a few seconds</strong> and can easily be <strong class="markup--strong markup--p-strong">scripted</strong> and <strong class="markup--strong markup--p-strong">scaled</strong> to as many instances as needed (<em class="markup--em markup--p-em">aws ec2 create volume</em>, <em class="markup--em markup--p-em">aws ec2 attach-volume</em>). For full automation, you could perform these operations as <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/user-data.html" data-href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/user-data.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">User Data</a> commands at instance launch.</p><h4 name="1795" id="1795" class="graf graf--h4 graf-after--p">Conclusion</h4><p name="127f" id="127f" class="graf graf--p graf-after--h4">Sure, it takes a while to download ImageNet, but thanks to the flexibility of EBS, we’re now able to deploy it <strong class="markup--strong markup--p-strong">as many times as needed in just a few seconds</strong>. Of course, you can easily apply this fast and cost-effective technique to other data sets :)</p><p name="fe11" id="fe11" class="graf graf--p graf-after--p">In the next post, we’ll train a model from scratch and focus on making sure that we get <strong class="markup--strong markup--p-strong">as much performance</strong> as possible from our GPU instance.</p><p name="0551" id="0551" class="graf graf--p graf-after--p graf--trailing">That’s it for today. As always, thank you for reading.</p></div></div></section><section name="dc79" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="fdf4" id="fdf4" class="graf graf--p graf--leading graf--trailing">This article was written while listening to vintage AC/DC songs: “<em class="markup--em markup--p-em">It’s a long way to the top if you wanna… train ImageNet</em>” ;)</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@julsimon" class="p-author h-card">Julien Simon</a> on <a href="https://medium.com/p/c0a62976dc72"><time class="dt-published" datetime="2017-09-19T09:32:39.025Z">September 19, 2017</time></a>.</p><p><a href="https://medium.com/@julsimon/imagenet-part-1-going-on-an-adventure-c0a62976dc72" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on July 26, 2025.</p></footer></article></body></html>
