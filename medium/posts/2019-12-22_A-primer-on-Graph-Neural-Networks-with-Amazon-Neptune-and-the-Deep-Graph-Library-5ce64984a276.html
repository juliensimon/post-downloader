<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>A primer on Graph Neural Networks with Amazon Neptune and the Deep Graph Library</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">A primer on Graph Neural Networks with Amazon Neptune and the Deep Graph Library</h1>
</header>
<section data-field="subtitle" class="p-summary">
In this post, I’d like to introduce you to Graph Neural Networks (GNN), one of the most exciting developments in Machine Learning (ML)…
</section>
<section data-field="body" class="e-content">
<section name="3e59" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="bd10" id="bd10" class="graf graf--h3 graf--leading graf--title">A primer on Graph Neural Networks with Amazon Neptune and the Deep Graph Library</h3><p name="f9c9" id="f9c9" class="graf graf--p graf-after--h3">In this post, I’d like to introduce you to <strong class="markup--strong markup--p-strong">Graph Neural Networks</strong> (GNN), one of the most exciting developments in Machine Learning (ML) today. Indeed, lots of datasets have an intrinsic graph structure (social networks, fraud detection, cybersecurity, etc.). Flattening them and feeding them to traditional neural network architectures doesn’t feel like the best option. Enter GNNs!</p><p name="32cc" id="32cc" class="graf graf--p graf-after--p">Instead of simply running a sample notebook, let’s throw a few extra ingredients into the mix. In a real life scenario, your graph data would be stored in a <strong class="markup--strong markup--p-strong">graph database</strong>, such as <a href="https://aws.amazon.com/neptune/" data-href="https://aws.amazon.com/neptune/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><strong class="markup--strong markup--p-strong">Amazon Neptune</strong></a>. You’d pull some data from that database, load it in a notebook, and experiment with an <strong class="markup--strong markup--p-strong">ML library specialized for GNNs</strong>, such as the <a href="https://www.dgl.ai" data-href="https://www.dgl.ai" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><strong class="markup--strong markup--p-strong">Deep Graph Library</strong></a>. Then, once you’d have figured out which algorithm to use, you’d probably train on the full dataset using a <strong class="markup--strong markup--p-strong">ML service</strong> such as <a href="https://aws.amazon.com/sagemaker" data-href="https://aws.amazon.com/sagemaker" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><strong class="markup--strong markup--p-strong">Amazon SageMaker</strong></a><strong class="markup--strong markup--p-strong">.</strong></p><p name="8b2d" id="8b2d" class="graf graf--p graf-after--p">So how about I show you all of that? Let’s get to</p><h3 name="5346" id="5346" class="graf graf--h3 graf-after--p">Creating a graph database</h3><p name="5cec" id="5cec" class="graf graf--p graf-after--h3"><a href="https://aws.amazon.com/neptune" data-href="https://aws.amazon.com/neptune" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Amazon Neptune</a> is a fully managed graph database service.It supports two query languages, Apache TinkerPop Gremlin and W3C’s SPARQL.</p><p name="4b85" id="4b85" class="graf graf--p graf-after--p">Creating a Neptune database is extremely similar to setting up <a href="https://aws.amazon.com/rds" data-href="https://aws.amazon.com/rds" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">RDS</a>. The simplest way is to use <a href="https://docs.aws.amazon.com/neptune/latest/userguide/get-started-create-cluster.html" data-href="https://docs.aws.amazon.com/neptune/latest/userguide/get-started-create-cluster.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">this</a> AWS CloudFormation <a href="https://docs.aws.amazon.com/neptune/latest/userguide/get-started-create-cluster.html" data-href="https://docs.aws.amazon.com/neptune/latest/userguide/get-started-create-cluster.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">template</a>. If you want to use the AWS console, the <a href="https://docs.aws.amazon.com/neptune/latest/userguide/manage-console-launch.html" data-href="https://docs.aws.amazon.com/neptune/latest/userguide/manage-console-launch.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">procedure</a> is straightforward.</p><p name="0113" id="0113" class="graf graf--p graf-after--p">After a few minutes, my Neptune database is up, and we’re ready to load data.</p><figure name="816b" id="816b" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*wmWtsQ_WxoJbnntXUtpNPA.png" data-width="2452" data-height="456" src="https://cdn-images-1.medium.com/max/800/1*wmWtsQ_WxoJbnntXUtpNPA.png"></figure><h3 name="868b" id="868b" class="graf graf--h3 graf-after--figure">Picking a data set</h3><p name="8aae" id="8aae" class="graf graf--p graf-after--h3">Let’s use the proverbial <a href="http://konect.cc/networks/ucidata-zachary/" data-href="http://konect.cc/networks/ucidata-zachary/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Zachary Karate Club</a> data set. It contains 34 vertices and 78 bidirectional edges.</p><figure name="1169" id="1169" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*F8IRknwoCILYIAVlxOU-eQ.png" data-width="446" data-height="302" src="https://cdn-images-1.medium.com/max/800/1*F8IRknwoCILYIAVlxOU-eQ.png"></figure><p name="77a5" id="77a5" class="graf graf--p graf-after--figure">As the story goes, edges represents ties between <strong class="markup--strong markup--p-strong">students</strong> and <strong class="markup--strong markup--p-strong">two teachers</strong> (nodes 0 and 33). Unfortunately, after an argument between the teachers, the group needs to be split in two. That’s the problem we’re going to solve with a GNN: more on this in a few minutes!</p><figure name="4f0c" id="4f0c" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="0*TmiBMafJDfPw9TuE.jpg" data-width="600" data-height="403" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/0*TmiBMafJDfPw9TuE.jpg"><figcaption class="imageCaption">All along, this was a machine learning story. Who would have thought?</figcaption></figure><h3 name="0440" id="0440" class="graf graf--h3 graf-after--figure">Formatting the data set</h3><p name="b50e" id="b50e" class="graf graf--p graf-after--h3">Neptune accepts different <a href="https://docs.aws.amazon.com/neptune/latest/userguide/bulk-load-tutorial-format.html" data-href="https://docs.aws.amazon.com/neptune/latest/userguide/bulk-load-tutorial-format.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">file formats</a>. I’ll go with the <a href="https://docs.aws.amazon.com/neptune/latest/userguide/bulk-load-tutorial-format-gremlin.html" data-href="https://docs.aws.amazon.com/neptune/latest/userguide/bulk-load-tutorial-format-gremlin.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Gremlin format</a>:</p><ul class="postList"><li name="9e16" id="9e16" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">Two CSV files</strong>: one for vertices, one for edges.</li><li name="4601" id="4601" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Vertex file</strong>: id (mandatory), plus a name property (optional).</li><li name="691f" id="691f" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Edge file</strong>: id, source vertex, destination vertex (all three are mandatory).</li></ul><blockquote name="fbab" id="fbab" class="graf graf--blockquote graf--hasDropCapModel graf-after--li">Vertex is just a fancy word for node.</blockquote><p name="b2ab" id="b2ab" class="graf graf--p graf-after--blockquote">Of course, you can (and should) add many more properties in both files.</p><p name="9e6d" id="9e6d" class="graf graf--p graf-after--p">Here are the two files in Gremlin format.</p><figure name="44cf" id="44cf" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/juliensimon/cfcbc15e3e98475851c7c4a913c46c41.js"></script></figure><figure name="6c59" id="6c59" class="graf graf--figure graf--iframe graf-after--figure"><script src="https://gist.github.com/juliensimon/d323d16296db6090accb0696832f0a52.js"></script></figure><h3 name="461d" id="461d" class="graf graf--h3 graf-after--figure">Loading the data set in Neptune</h3><p name="4190" id="4190" class="graf graf--p graf-after--h3">Neptune is a little peculiar when it comes to loading data:</p><ol class="postList"><li name="ca80" id="ca80" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">A database is only accessible inside og the VPC hosting it. </strong>For exemple, you could load data using an EC2 instance or a Lambda function living in that same VPC.</li><li name="f822" id="f822" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Neptune requires a VPC Endpoint for S3 in the VPC</strong>. This allows Neptune to access S3 directly without using public endpoints. <a href="https://docs.aws.amazon.com/neptune/latest/userguide/bulk-load-data.html#bulk-load-prereqs-s3" data-href="https://docs.aws.amazon.com/neptune/latest/userguide/bulk-load-data.html#bulk-load-prereqs-s3" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Creating the endpoint</a> takes a few seconds, and you only need to do it once per VPC.</li><li name="eb3b" id="eb3b" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Data loading is initiated by a </strong><a href="https://curl.haxx.se/" data-href="https://curl.haxx.se/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank"><strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em">curl</em></strong></a><strong class="markup--strong markup--li-strong"> call</strong>. Nothing weird, just pay attention to the parameters.</li></ol><p name="e7be" id="e7be" class="graf graf--p graf-after--li">Ok, with this out of the way, let’s load data. First, I’m copying my two files in an S3 bucket hosted in the same region as my Neptune cluster.</p><pre name="8337" id="8337" class="graf graf--pre graf-after--p">$ aws s3 cp edges.csv s3://jsimon-neptune-useast-1/dgl/<br>$ aws s3 cp nodes.csv s3://jsimon-neptune-useast-1/dgl/</pre><p name="4867" id="4867" class="graf graf--p graf-after--pre">Then, it’s time for that <em class="markup--em markup--p-em">curl</em> call, using the <strong class="markup--strong markup--p-strong">cluster endpoint</strong> visible in the AWS console, or in the output of the CloudFormation template. I’m using the us-east-1 region, you should of course change this if you use a different region.</p><pre name="a0e5" id="a0e5" class="graf graf--pre graf-after--p">$ curl -X POST \<br> -H ‘Content-Type: application/json’ \<br> <a href="https://neptune-instance-1.c0n7pykyhnp4.us-east-1.neptune.amazonaws.com:8182/loader" data-href="https://neptune-instance-1.c0n7pykyhnp4.us-east-1.neptune.amazonaws.com:8182/loader" class="markup--anchor markup--pre-anchor" rel="nofollow noopener noopener" target="_blank">https://ENDPOINT:PORT/loader</a> -d ‘<br> {<br> “source” : “s3://jsimon-neptune-useast-1/dgl/”,<br> “format” : “csv”,<br> “iamRoleArn” : “arn:aws:iam::123456789012:role/NeptuneRoleForS3”,<br> “region” : “us-east-1”,<br> “failOnError” : “FALSE”,<br> “parallelism” : “MEDIUM”,<br> “updateSingleCardinalityProperties” : “FALSE”<br> }’</pre><p name="654f" id="654f" class="graf graf--p graf-after--pre">If everything is set right, this returns a 200 HTTP status and a job id: I can use it to check if data loading worked ok.</p><pre name="95ce" id="95ce" class="graf graf--pre graf-after--p">$ curl -G ‘<a href="https://neptune-instance-1.c0n7pykyhnp4.us-east-1.neptune.amazonaws.com:8182/loader/8af0f90a-9b72-4835-ab55-2de58918aa81%27" data-href="https://neptune-instance-1.c0n7pykyhnp4.us-east-1.neptune.amazonaws.com:8182/loader/8af0f90a-9b72-4835-ab55-2de58918aa81&#39;" class="markup--anchor markup--pre-anchor" rel="nofollow noopener noopener" target="_blank">https://ENDPOINT:PORT/loader/8af0f90a-9b72-4835-ab55-2de58918aa81&#39;</a><br>{<br> “status” : “200 OK”,<br> “payload” : {<br> “feedCount” : [<br> {<br> “LOAD_COMPLETED” : 2<br> }<br> ],<br> “overallStatus” : {<br>   “fullUri” : “s3://jsimon-neptune-useast-1/dgl/”,<br>   “runNumber” : 1,<br>   “retryNumber” : 0,<br>   “status” : “LOAD_COMPLETED”,<br>   “totalTimeSpent” : 6,<br>   “startTime” : 1576847947,<br>   “totalRecords” : 146,<br>   “totalDuplicates” : 0,<br>   “parsingErrors” : 0,<br>   “datatypeMismatchErrors” : 0,<br>   “insertErrors” : 0<br> }<br> }</pre><blockquote name="b594" id="b594" class="graf graf--blockquote graf--hasDropCapModel graf-after--pre">Things to check (in this order) if you’re having issues: are you in the same VPC? Are you using the correct endpoint and port for Neptune? Is the Security Group for Neptune OK? Is the IAM Role for Neptune OK? Does the S3 Endpoint exist, and does it allow access (endpoint policy) ? Does the S3 bucket exist, and does it allow access (bucket policy)? Do files exist and have the right format? If you still can’t figure it out, the <a href="https://forums.aws.amazon.com/forum.jspa?forumID=253" data-href="https://forums.aws.amazon.com/forum.jspa?forumID=253" class="markup--anchor markup--blockquote-anchor" rel="noopener" target="_blank">AWS Forum for Neptune</a> is waiting for you ;)</blockquote><p name="8a57" id="8a57" class="graf graf--p graf-after--blockquote">Now let’s connect to Neptune, and explore out data a bit.</p><h3 name="5046" id="5046" class="graf graf--h3 graf-after--p">Exploring graph data with Gremlin</h3><p name="0562" id="0562" class="graf graf--p graf-after--h3">You can query a Neptune using <a href="https://docs.aws.amazon.com/neptune/latest/userguide/access-graph-gremlin.html" data-href="https://docs.aws.amazon.com/neptune/latest/userguide/access-graph-gremlin.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">different languages</a>. I’ll use Python with the <a href="https://pypi.org/project/gremlinpython/" data-href="https://pypi.org/project/gremlinpython/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><em class="markup--em markup--p-em">gremlinpython</em></a> library.</p><pre name="dcda" id="dcda" class="graf graf--pre graf-after--p">$ pip3 install <a href="https://pypi.org/project/gremlinpython/" data-href="https://pypi.org/project/gremlinpython/" class="markup--anchor markup--pre-anchor" rel="noopener" target="_blank">gremlinpython</a> --user</pre><p name="e3fd" id="e3fd" class="graf graf--p graf-after--pre">Connecting to the Neptune database only requires its endpoint and its port.</p><blockquote name="f6bd" id="f6bd" class="graf graf--blockquote graf--hasDropCapModel graf-after--p">Remember that this code must be run inside the appropriate VPC!</blockquote><figure name="59d2" id="59d2" class="graf graf--figure graf--iframe graf-after--blockquote"><script src="https://gist.github.com/juliensimon/6fbe10cd9f532eb06908afecac6c981a.js"></script></figure><p name="c930" id="c930" class="graf graf--p graf-after--figure">Now, I can explore the graph with the <a href="https://tinkerpop.apache.org/gremlin.html" data-href="https://tinkerpop.apache.org/gremlin.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Gremlin</a> query language. Here are some examples.</p><figure name="c41e" id="c41e" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/juliensimon/cb01a263caa17e2ba012c73135003e0f.js"></script></figure><p name="e6d8" id="e6d8" class="graf graf--p graf-after--figure">There’s <a href="https://tinkerpop.apache.org/gremlin.html" data-href="https://tinkerpop.apache.org/gremlin.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">much much more</a> to this, but I’ll stop there. Actually, the only thing that I need to build the graph in my Deep Graph Library script is a <strong class="markup--strong markup--p-strong">list of all edges</strong>.</p><p name="01b0" id="01b0" class="graf graf--p graf-after--p">Let’s grab that, and save it to a <a href="https://docs.python.org/3/library/pickle.html" data-href="https://docs.python.org/3/library/pickle.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><em class="markup--em markup--p-em">pickle</em></a> file.</p><figure name="a6be" id="a6be" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/juliensimon/bf403673ab3c4a691f86cb1f0ac70cad.js"></script></figure><p name="a036" id="a036" class="graf graf--p graf-after--figure">We’re done with data processing. Let’s now train a GNN!</p><h3 name="2612" id="2612" class="graf graf--h3 graf-after--p">Training our first GNN with the Deep Graph Library</h3><p name="ce46" id="ce46" class="graf graf--p graf-after--h3">The <a href="https://dgl.ai" data-href="https://dgl.ai" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Deep Graph Library</a> (DGL) is an open source project that simplifies working with GNN models. It’s implemented in Python, and supports <a href="https://mxnet.apache.org" data-href="https://mxnet.apache.org" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Apache MXNet</a> and <a href="https://pytorch.org" data-href="https://pytorch.org" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">PyTorch</a>.</p><pre name="d8b1" id="d8b1" class="graf graf--pre graf-after--p">$ pip3 install dgl --user</pre><p name="d08c" id="d08c" class="graf graf--p graf-after--pre">In the next sections, I’m using a modified version on this <a href="https://docs.dgl.ai/tutorials/basics/1_first.html" data-href="https://docs.dgl.ai/tutorials/basics/1_first.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">tutorial</a>. As usual, the notebook is available on <a href="https://gitlab.com/juliensimon/dlnotebooks/tree/master/dgl/01_karate_club" data-href="https://gitlab.com/juliensimon/dlnotebooks/tree/master/dgl/01_karate_club" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Github</a>.</p><p name="cac5" id="cac5" class="graf graf--p graf-after--p">I also recorded a video where I go through the notebook, and explain every line of code in more detail that you probably care for ;)</p><figure name="8b16" id="8b16" class="graf graf--figure graf--iframe graf-after--p"><iframe src="https://www.youtube.com/embed/2bfxnj1J00A?feature=oembed" width="700" height="393" frameborder="0" scrolling="no"></iframe></figure><h4 name="5557" id="5557" class="graf graf--h4 graf-after--figure">Building the graph</h4><p name="4176" id="4176" class="graf graf--p graf-after--h4">First things first: we need to load the list of edges, and build our graph.</p><figure name="6090" id="6090" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/juliensimon/5bb079d9eea91e0f79ddab3729a536e6.js"></script></figure><h4 name="a386" id="a386" class="graf graf--h4 graf-after--figure">Defining the problem</h4><p name="347b" id="347b" class="graf graf--p graf-after--h4">Let’s think about our initial problem for a minute. For each node (student), we want to figure out if it should be grouped with node 0 (the first teacher) or with node 33 (the second teacher).</p><p name="a897" id="a897" class="graf graf--p graf-after--p">We can formulate this as a <strong class="markup--strong markup--p-strong">semi-supervised binary classification problem</strong>:</p><ul class="postList"><li name="40b5" id="40b5" class="graf graf--li graf-after--p">Let’s label node 0 with class 0,</li><li name="70ff" id="70ff" class="graf graf--li graf-after--li">Let’s label node 33 with class 1,</li><li name="ba65" id="ba65" class="graf graf--li graf-after--li">All other nodes are unlabeled, and the purpose of the training job will be to learn their correct class.</li></ul><h4 name="bdf4" id="bdf4" class="graf graf--h4 graf-after--li">Building the GNN</h4><p name="5d6b" id="5d6b" class="graf graf--p graf-after--h4">Now let’s build the GNN itself. We’ll use a <strong class="markup--strong markup--p-strong">Graph Convolutional Network</strong> (GCN), with the following structure:</p><ul class="postList"><li name="ceff" id="ceff" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">Two GCN layers</strong> (which we’ll define in a minute). Their purpose is to <strong class="markup--strong markup--li-strong">learn parameters</strong> that will help us compute classes for all nodes. In the process, they also gradually <strong class="markup--strong markup--li-strong">shrink the feature space</strong> to two dimensions (one for each class).</li><li name="e27e" id="e27e" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">A built-in softmax layer</strong>, in order to output probabilities for the two classes.</li></ul><figure name="de7d" id="de7d" class="graf graf--figure graf--iframe graf-after--li"><script src="https://gist.github.com/juliensimon/54be78df11515fe1cada9fd5cc912425.js"></script></figure><p name="fc70" id="fc70" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">Forward propagation</strong> for a GCN layer looks like this:</p><ul class="postList"><li name="7775" id="7775" class="graf graf--li graf-after--p">Set input features for all nodes,</li><li name="bed5" id="bed5" class="graf graf--li graf-after--li">Ask each node to <strong class="markup--strong markup--li-strong">send its features</strong> across all its edges,</li><li name="186c" id="186c" class="graf graf--li graf-after--li">At each destination node, <strong class="markup--strong markup--li-strong">update features to the sum of source node features</strong> (this is the secret sauce in GCNs),</li><li name="eef8" id="eef8" class="graf graf--li graf-after--li">Apply a linear transformation (think Y=WX+B… with matrices) to <strong class="markup--strong markup--li-strong">reduce dimensionality</strong>.</li></ul><p name="f110" id="f110" class="graf graf--p graf-after--li">As you can see in the code below, DGL provides simple <strong class="markup--strong markup--p-strong">message passing semantics</strong> to handle node communication.</p><figure name="4383" id="4383" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/juliensimon/fb07ea736fd34bd863decd2c70b3c48e.js"></script></figure><p name="d4a1" id="d4a1" class="graf graf--p graf-after--figure">Let me repeat the central idea in GCNs: <strong class="markup--strong markup--p-strong">the features of each node will be repeatedly updated by summing the features of adjacent nodes</strong>. This is similar to the <a href="http://deeplearning.net/software/theano/tutorial/conv_arithmetic.html" data-href="http://deeplearning.net/software/theano/tutorial/conv_arithmetic.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">convolution</a> operation implemented in Convolution Neural Networks (which sums adjacent pixel values), hence the GCN name.</p><blockquote name="0d09" id="0d09" class="graf graf--blockquote graf-after--p">Why this works is beyond the scope of this post. If you’re curious about GCN theory, this excellent <a href="https://towardsdatascience.com/how-to-do-deep-learning-on-graphs-with-graph-convolutional-networks-7d2250723780" data-href="https://towardsdatascience.com/how-to-do-deep-learning-on-graphs-with-graph-convolutional-networks-7d2250723780" class="markup--anchor markup--blockquote-anchor" rel="noopener" target="_blank">2-part post</a> is the best I’ve found. Of course, you can also read the <a href="https://arxiv.org/abs/1609.02907" data-href="https://arxiv.org/abs/1609.02907" class="markup--anchor markup--blockquote-anchor" rel="noopener" target="_blank">research paper</a>.</blockquote><h4 name="5d38" id="5d38" class="graf graf--h4 graf-after--blockquote">Training the GNN</h4><p name="903f" id="903f" class="graf graf--p graf-after--h4">Input features are stored in a matrix <em class="markup--em markup--p-em">(number_of_nodes</em> lines and <em class="markup--em markup--p-em">number_of_features</em> columns).</p><p name="5c86" id="5c86" class="graf graf--p graf-after--p">Here, the only feature for each node is a <strong class="markup--strong markup--p-strong">one-hot encoded vector representing the node id</strong>. Stacking all node vectors, we get an identity matrix of size <em class="markup--em markup--p-em">node_count</em>, which we can easily build with <a href="https://pytorch.org/docs/stable/torch.html" data-href="https://pytorch.org/docs/stable/torch.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><em class="markup--em markup--p-em">torch.eye()</em></a>.</p><p name="0e85" id="0e85" class="graf graf--p graf-after--p">DGL makes it easy to assign node features. In the code above, <em class="markup--em markup--p-em">g.ndata[‘h’] = inputs </em>creates a feature named ‘h’ on each node, and sets it to the appropriate row in the <em class="markup--em markup--p-em">inputs</em> matrix.</p><blockquote name="a9e0" id="a9e0" class="graf graf--blockquote graf-after--p">In a real-life scenario, we would use more features, probably extracted or computed from the graph database, e.g. node properties, distance to nodes 0 and 33, etc.</blockquote><p name="154f" id="154f" class="graf graf--p graf-after--blockquote">We also need to <strong class="markup--strong markup--p-strong">define labels</strong>: we only label nodes 0 and 33, respectively with class 0 and 1.</p><figure name="81e6" id="81e6" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/juliensimon/374b47b5559299c00ae390dfd2220864.js"></script></figure><p name="9f00" id="9f00" class="graf graf--p graf-after--figure">The training loop itself is PyTorch business as usual:</p><ul class="postList"><li name="b3e6" id="b3e6" class="graf graf--li graf-after--p">Run <strong class="markup--strong markup--li-strong">forward propagation </strong>on the graph and its inputs,</li><li name="a96e" id="a96e" class="graf graf--li graf-after--li">Compute the <strong class="markup--strong markup--li-strong">loss</strong> between predictions and labels (only for labeled nodes),</li><li name="63bf" id="63bf" class="graf graf--li graf-after--li">Run <strong class="markup--strong markup--li-strong">backpropagation,</strong> and update layer weights.</li></ul><figure name="4d05" id="4d05" class="graf graf--figure graf--iframe graf-after--li"><script src="https://gist.github.com/juliensimon/d30307dd71c68f11c6ece0aa86315b4f.js"></script></figure><p name="2813" id="2813" class="graf graf--p graf-after--figure">Let’s try to put this in plain English: <strong class="markup--strong markup--p-strong">by learning from two labeled nodes, we update layer parameters that let us compute class probabilities for all other nodes</strong>.</p><h4 name="80e7" id="80e7" class="graf graf--h4 graf-after--p">Visualizing results</h4><p name="7e99" id="7e99" class="graf graf--p graf-after--h4">Once training is complete, we can easily find the class of all nodes by looking at the epoch outputs.</p><figure name="a9fb" id="a9fb" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/juliensimon/791fea21ec401b318f9458b300e61e26.js"></script></figure><p name="6ce2" id="6ce2" class="graf graf--p graf-after--figure">A picture is worth a thousand words!</p><figure name="4dc7" id="4dc7" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*XU-K2U00t-HTw1tM-w6rbQ.png" data-width="349" data-height="231" src="https://cdn-images-1.medium.com/max/800/1*XU-K2U00t-HTw1tM-w6rbQ.png"><figcaption class="imageCaption">Epoch 10</figcaption></figure><figure name="fdee" id="fdee" class="graf graf--figure graf-after--figure"><img class="graf-image" data-image-id="1*dhdjOgFF2IEYwFd8ZB-S8A.png" data-width="349" data-height="231" src="https://cdn-images-1.medium.com/max/800/1*dhdjOgFF2IEYwFd8ZB-S8A.png"><figcaption class="imageCaption">Epoch 20</figcaption></figure><figure name="f43c" id="f43c" class="graf graf--figure graf-after--figure"><img class="graf-image" data-image-id="1*NJ-YYl7VRSvDSE3YuvE9kA.png" data-width="349" data-height="231" src="https://cdn-images-1.medium.com/max/800/1*NJ-YYl7VRSvDSE3YuvE9kA.png"><figcaption class="imageCaption">Last epoch</figcaption></figure><p name="58ec" id="58ec" class="graf graf--p graf-after--figure">Pretty cool! This looks like a reasonable split, doesn’t it?</p><h3 name="794e" id="794e" class="graf graf--h3 graf-after--p">Training at scale with Amazon SageMaker</h3><p name="1a5f" id="1a5f" class="graf graf--p graf-after--h3">DGL is available in the <a href="https://docs.aws.amazon.com/dlami/latest/devguide/deep-learning-containers-images.html" data-href="https://docs.aws.amazon.com/dlami/latest/devguide/deep-learning-containers-images.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">AWS Deep Learning Containers</a>, which you can easily train on EC2, container services, and of course on <a href="https://aws.amazon.com/sagemaker$" data-href="https://aws.amazon.com/sagemaker$" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Amazon SageMaker</a>.</p><figure name="09ba" id="09ba" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*KkLmkBtfAXdQSRWCJCuG1A.png" data-width="1094" data-height="834" src="https://cdn-images-1.medium.com/max/800/1*KkLmkBtfAXdQSRWCJCuG1A.png"></figure><p name="9c91" id="9c91" class="graf graf--p graf-after--figure">If you’d like to know more about combining DGL and SageMaker, here are some resources:</p><ul class="postList"><li name="8029" id="8029" class="graf graf--li graf-after--p"><a href="https://aws.amazon.com/blogs/aws/now-available-on-amazon-sagemaker-the-deep-graph-library/" data-href="https://aws.amazon.com/blogs/aws/now-available-on-amazon-sagemaker-the-deep-graph-library/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Blog post,</a></li><li name="12f9" id="12f9" class="graf graf--li graf-after--li">AWS <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/deep-graph-library.html" data-href="https://docs.aws.amazon.com/sagemaker/latest/dg/deep-graph-library.html" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">documentation,</a></li><li name="36c1" id="36c1" class="graf graf--li graf-after--li">Sample <a href="https://github.com/awslabs/amazon-sagemaker-examples/tree/master/sagemaker-python-sdk" data-href="https://github.com/awslabs/amazon-sagemaker-examples/tree/master/sagemaker-python-sdk" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">notebooks</a>.</li></ul><h3 name="de21" id="de21" class="graf graf--h3 graf-after--li">Conclusion</h3><p name="cd99" id="cd99" class="graf graf--p graf-after--h3">That’s it for today. I hope you now have a basic understanding of GNNs, and how to get started with them on AWS.</p><p name="d8a3" id="d8a3" class="graf graf--p graf-after--p graf--trailing">As always, thank you for reading. Happy to answer questions here or on <a href="https://twitter.com/julsimon" data-href="https://twitter.com/julsimon" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Twitter</a>.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@julsimon" class="p-author h-card">Julien Simon</a> on <a href="https://medium.com/p/5ce64984a276"><time class="dt-published" datetime="2019-12-22T17:48:16.221Z">December 22, 2019</time></a>.</p><p><a href="https://medium.com/@julsimon/a-primer-on-graph-neural-networks-with-amazon-neptune-and-the-deep-graph-library-5ce64984a276" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on July 26, 2025.</p></footer></article></body></html>
