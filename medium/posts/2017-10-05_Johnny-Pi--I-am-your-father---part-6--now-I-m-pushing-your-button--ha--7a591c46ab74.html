<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Johnny Pi, I am your father — part 6: now I’m pushing your button, ha!</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Johnny Pi, I am your father — part 6: now I’m pushing your button, ha!</h1>
</header>
<section data-field="subtitle" class="p-summary">
In previous posts, we gave our robot the gift of sight thanks to Amazon Rekognition and Apache MXNet, as well as the gift of speech thanks…
</section>
<section data-field="body" class="e-content">
<section name="f7dc" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="265e" id="265e" class="graf graf--h3 graf--leading graf--title">Johnny Pi, I am your father — part 6: now I’m pushing your button, ha!</h3><p name="08c8" id="08c8" class="graf graf--p graf-after--h3">In previous posts, we gave our robot the gift of sight thanks to <a href="https://medium.com/@julsimon/johnny-pi-i-am-your-father-part-4-adding-cloud-based-vision-8830c2676113" data-href="https://medium.com/@julsimon/johnny-pi-i-am-your-father-part-4-adding-cloud-based-vision-8830c2676113" class="markup--anchor markup--p-anchor" target="_blank">Amazon Rekognition</a> and <a href="https://medium.com/@julsimon/johnny-pi-i-am-your-father-part-5-adding-mxnet-for-local-image-classification-bc27a5fd2c27" data-href="https://medium.com/@julsimon/johnny-pi-i-am-your-father-part-5-adding-mxnet-for-local-image-classification-bc27a5fd2c27" class="markup--anchor markup--p-anchor" target="_blank">Apache MXNet</a>, as well as the gift of speech thanks to <a href="https://medium.com/@julsimon/johnny-pi-i-am-your-father-part-3-adding-cloud-based-speech-fb6e4f207c76" data-href="https://medium.com/@julsimon/johnny-pi-i-am-your-father-part-3-adding-cloud-based-speech-fb6e4f207c76" class="markup--anchor markup--p-anchor" target="_blank">Amazon Polly</a>.</p><p name="9292" id="9292" class="graf graf--p graf-after--p">In this post, I’ll show you how to send orders to the robot with an <a href="https://aws.amazon.com/iotbutton/" data-href="https://aws.amazon.com/iotbutton/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">AWS IoT button</a>. Specifically, pushing the button will trigger object detection using the MXNet model.</p><p name="7197" id="7197" class="graf graf--p graf-after--p">Let’s get started.</p><figure name="e923" id="e923" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*dPovpIqltl2RLYvVNL_Y3A.png" data-width="1792" data-height="930" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*dPovpIqltl2RLYvVNL_Y3A.png"></figure><h4 name="043b" id="043b" class="graf graf--h4 graf-after--figure">Registering the IoT button in AWS IoT</h4><p name="f0d6" id="f0d6" class="graf graf--p graf-after--h4">Just like for the robot and the joystick, we need to register the IoT button in AWS IoT: create a certificate, a key pair, an IAM policy, etc. <a href="https://docs.aws.amazon.com/iot/latest/developerguide/iot-gs.html" data-href="https://docs.aws.amazon.com/iot/latest/developerguide/iot-gs.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">The process</a> is always the same, so just repeat the same steps and download all credentials on your local machine.</p><h4 name="529b" id="529b" class="graf graf--h4 graf-after--p">Setting up the IoT button</h4><p name="097d" id="097d" class="graf graf--p graf-after--h4">This couldn’t be simpler. Just press the button for 5 seconds and a new Wi-Fi hotspot will appear. Connect to it, enter the Wi-Fi settings and the endpoint of the IoT gateway, upload the credentials and you’re done.</p><blockquote name="cd44" id="cd44" class="graf graf--blockquote graf-after--p">If you need help with the two previous steps, here’s a detailed video tutorial I recorded some time ago.</blockquote><figure name="4b53" id="4b53" class="graf graf--figure graf--iframe graf-after--blockquote"><iframe src="https://www.youtube.com/embed/oIPsQhStbnY?feature=oembed" width="700" height="393" frameborder="0" scrolling="no"></iframe></figure><p name="3228" id="3228" class="graf graf--p graf-after--figure">Now let’s take care of the Lambda function which will be invoked when we press the button.</p><h4 name="c703" id="c703" class="graf graf--h4 graf-after--p">Creating a role for the Lambda function</h4><p name="5212" id="5212" class="graf graf--p graf-after--h4">You didn’t think you’d escape IAM,did you? ;) Of course, we need to create a role — let’s call <em class="markup--em markup--p-em">iotButtonLambdaRole</em> — and a policy allowing the Lambda function to connect to AWS IoT and publish a message to the MQTT topic. Just go the the IAM console, create the role as a Lambda service role and attach the following policy.</p><figure name="5668" id="5668" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/juliensimon/ee51460d0c1e8abcef910ffaeab2f3ee.js"></script></figure><p name="09ae" id="09ae" class="graf graf--p graf-after--figure">The last statement is important. It allows the Lambda function to log in CloudWatch logs and you might need it for debugging later on ;)</p><h4 name="713d" id="713d" class="graf graf--h4 graf-after--p">Writing the Lambda function</h4><p name="1a58" id="1a58" class="graf graf--p graf-after--h4">We’ll keep things very simple: whenever the button is pushed and whatever the click type (short, long or double), we’ll post an message to the <em class="markup--em markup--p-em">JohnnyPi/see</em> MQTT topic.</p><blockquote name="a6b3" id="a6b3" class="graf graf--blockquote graf--hasDropCapModel graf-after--p">If you’re curious how to use different click types to do different things, here’s another <a href="https://medium.com/@julsimon/how-to-configure-an-aws-iot-button-7f43919afd97" data-href="https://medium.com/@julsimon/how-to-configure-an-aws-iot-button-7f43919afd97" class="markup--anchor markup--blockquote-anchor" target="_blank">post</a> that shows you how to do that.</blockquote><p name="f56c" id="f56c" class="graf graf--p graf-after--blockquote">Here’s the code for the Lambda function.</p><figure name="a9b5" id="a9b5" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/juliensimon/08d460a78692a48bec5f4d434b15ed46.js"></script></figure><p name="a5f6" id="a5f6" class="graf graf--p graf-after--figure">As you can see, this is pretty straightforward. We’re reusing the same IoT code as for the robot. Just make sure you used the right IoT credentials in <em class="markup--em markup--p-em">iot_config.py</em>.</p><h4 name="e336" id="e336" class="graf graf--h4 graf-after--p">Packaging and creating the Lambda function</h4><p name="fe17" id="fe17" class="graf graf--p graf-after--h4">We need to embed the AWS IoT SDK in the function package, so let’s first install it locally.</p><pre name="bf42" id="bf42" class="graf graf--pre graf-after--p">pip install AWSIoTPythonSDK -t .</pre><p name="fa73" id="fa73" class="graf graf--p graf-after--pre">Then, we simply need to zip everything…</p><pre name="0bf5" id="0bf5" class="graf graf--pre graf-after--p">zip -9r lambda.zip AWSIoTPythonSDK* iot_config.py lambda.py</pre><p name="4abe" id="4abe" class="graf graf--p graf-after--pre">…and we can create the function with the AWS CLI.</p><pre name="2e36" id="2e36" class="graf graf--pre graf-after--p">aws lambda create-function --function-name iot_pi <br>--handler func.lambda_handler --zip-file fileb://lambda.zip<br>--runtime python2.7 --memory-size 128 --region eu-west-1 <br>--role arn:aws:iam::ACCOUNT_NUMBER:role/iotButtonLambdaRole</pre><p name="2f15" id="2f15" class="graf graf--p graf-after--pre">Or you can click in the console, you devil you!</p><h4 name="ec73" id="ec73" class="graf graf--h4 graf-after--p">Writing the AWS IoT rule</h4><p name="6894" id="6894" class="graf graf--p graf-after--h4">We’re missing one last part: the IoT rule which will trigger the Lambda function whenever a MQTT message is sent by the IoT button.</p><blockquote name="6e0e" id="6e0e" class="graf graf--blockquote graf-after--p">Read <a href="http://docs.aws.amazon.com/iot/latest/developerguide/iot-rules.html" data-href="http://docs.aws.amazon.com/iot/latest/developerguide/iot-rules.html" class="markup--anchor markup--blockquote-anchor" rel="noopener" target="_blank">this</a> if you’re unfamiliar with rules.</blockquote><p name="abe2" id="abe2" class="graf graf--p graf-after--blockquote">Just head out to the IoT console and create the rule. It couldn’t be simpler: select every single message…</p><figure name="e2ba" id="e2ba" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*M6rO-Yb_5No1Yx7--tUdJA.png" data-width="1410" data-height="294" src="https://cdn-images-1.medium.com/max/800/1*M6rO-Yb_5No1Yx7--tUdJA.png"></figure><p name="05e8" id="05e8" class="graf graf--p graf-after--figure">…and invoke the Lambda function.</p><figure name="c113" id="c113" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*xrf3BL4MXN3a3-TWIh-E5w.png" data-width="1074" data-height="542" src="https://cdn-images-1.medium.com/max/800/1*xrf3BL4MXN3a3-TWIh-E5w.png"></figure><h4 name="a9ab" id="a9ab" class="graf graf--h4 graf-after--figure">Testing and troubleshooting</h4><p name="2bba" id="2bba" class="graf graf--p graf-after--h4">Just push the button and see what happens :) If you run into issues, here are some troubleshooting tips:</p><ul class="postList"><li name="5d04" id="5d04" class="graf graf--li graf-after--p">Test that the button successfully connects to the IoT gateway and posts the message. You should see this on the dashboard of the IoT console. If not, check Wi-Fi settings, button credentials and button policy.</li><li name="7c07" id="7c07" class="graf graf--li graf-after--li">Test that the rule works. If the Lambda isn’t invoked, check rule settings, especially the topic name. It’s easy to get the serial number wrong.</li><li name="40d0" id="40d0" class="graf graf--li graf-after--li">Test that the function works. If the Lambda fails, head out directly to CloudWatch Logs and you’ll get more information.</li></ul><p name="29cb" id="29cb" class="graf graf--p graf-after--li">At some point, it’s going to work and it should look something like this. The video below is in French but you’ll get the point, I’m sure. Make sure to enable automatic subtitles for extra fun!</p><figure name="9614" id="9614" class="graf graf--figure graf--iframe graf-after--p"><iframe src="https://www.youtube.com/embed/L4wLrs6ugzY?feature=oembed" width="700" height="393" frameborder="0" scrolling="no"></iframe></figure><p name="dd0b" id="dd0b" class="graf graf--p graf-after--figure">That’s it for today. As usual, you’ll find all code on <a href="https://github.com/juliensimon/johnnypi/tree/master/part6" data-href="https://github.com/juliensimon/johnnypi/tree/master/part6" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Github</a>. In the next post, we’ll build an Alexa skill to issue voice commands!</p><p name="1c2f" id="1c2f" class="graf graf--p graf-after--p">Thanks for reading.</p><p name="5637" id="5637" class="graf graf--p graf-after--p">Part 0: <a href="https://medium.com/@julsimon/johnny-pi-i-am-your-father-part-0-1eb537e5a36" data-href="https://medium.com/@julsimon/johnny-pi-i-am-your-father-part-0-1eb537e5a36" class="markup--anchor markup--p-anchor" target="_blank">a sneak preview</a></p><p name="4525" id="4525" class="graf graf--p graf-after--p">Part 1: <a href="https://becominghuman.ai/johnny-pi-i-am-your-father-part-1-moving-around-e09fe95bbfce" data-href="https://becominghuman.ai/johnny-pi-i-am-your-father-part-1-moving-around-e09fe95bbfce" class="markup--anchor markup--p-anchor" rel="noopener nofollow nofollow noopener nofollow noopener noopener" target="_blank">moving around</a></p><p name="58a9" id="58a9" class="graf graf--p graf-after--p">Part 2: <a href="https://becominghuman.ai/johnny-pi-i-am-your-father-part-2-the-joystick-db8ac067e86" data-href="https://becominghuman.ai/johnny-pi-i-am-your-father-part-2-the-joystick-db8ac067e86" class="markup--anchor markup--p-anchor" rel="nofollow noopener nofollow noopener nofollow noopener noopener" target="_blank">the joystick</a></p><p name="a175" id="a175" class="graf graf--p graf-after--p">Part 3: <a href="https://medium.com/@julsimon/johnny-pi-i-am-your-father-part-3-adding-cloud-based-speech-fb6e4f207c76" data-href="https://medium.com/@julsimon/johnny-pi-i-am-your-father-part-3-adding-cloud-based-speech-fb6e4f207c76" class="markup--anchor markup--p-anchor" target="_blank">cloud-based speech</a></p><p name="7aa6" id="7aa6" class="graf graf--p graf-after--p">Part 4: <a href="https://medium.com/@julsimon/johnny-pi-i-am-your-father-part-4-adding-cloud-based-vision-8830c2676113" data-href="https://medium.com/@julsimon/johnny-pi-i-am-your-father-part-4-adding-cloud-based-vision-8830c2676113" class="markup--anchor markup--p-anchor" target="_blank">cloud-based vision</a></p><p name="8772" id="8772" class="graf graf--p graf-after--p graf--trailing">Part 5: <a href="https://medium.com/@julsimon/johnny-pi-i-am-your-father-part-4-adding-cloud-based-vision-8830c2676113" data-href="https://medium.com/@julsimon/johnny-pi-i-am-your-father-part-4-adding-cloud-based-vision-8830c2676113" class="markup--anchor markup--p-anchor" target="_blank">local vision</a></p></div></div></section><section name="713b" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="f81a" id="f81a" class="graf graf--p graf--leading graf--trailing"><em class="markup--em markup--p-em">This post was written in the Air France lounge at JFK, the proud home of the crappiest wi-fi connection this side of Alpha Centauri. To make things worse, harmful doses of caffeine and Mercyful Fate were unsuccessful in countering the effects of jet lag. Oh well.</em></p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@julsimon" class="p-author h-card">Julien Simon</a> on <a href="https://medium.com/p/7a591c46ab74"><time class="dt-published" datetime="2017-10-05T22:10:08.240Z">October 5, 2017</time></a>.</p><p><a href="https://medium.com/@julsimon/johnny-pi-i-am-your-father-part-6-now-im-pushing-your-button-ha-7a591c46ab74" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on July 26, 2025.</p></footer></article></body></html>
