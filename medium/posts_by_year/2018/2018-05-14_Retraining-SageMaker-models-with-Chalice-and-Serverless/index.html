<!DOCTYPE html>

<html><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"/><title>Retraining SageMaker models with Chalice and Serverless</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<section class="e-content" data-field="body">
<section class="section"><div><hr/></div><div><div><h3 id="d764">Retraining SageMaker models with Chalice and Serverless</h3><p id="ff63"><a href="https://aws.amazon.com/sagemaker" target="_blank">Amazon SageMaker</a> makes it easy to train (and deploy) Machine Learning models at scale. Thanks to its <a href="https://github.com/aws/sagemaker-python-sdk" target="_blank">Python SDK</a>, developers can first experiment with their data set and model using a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/how-it-works-notebooks-instances.html" target="_blank">notebook instance</a>. Once they’re happy with a model, it’s quite likely that they will need to train it again and again with new data or new parameters.</p><p id="684e">In this post, I will show you how to <strong class="markup--p-strong">retrain a SageMaker model</strong> in two simple ways:</p><p id="49df">1 — <strong class="markup--p-strong">On-demand</strong>, using a <strong class="markup--p-strong">web service</strong> implemented with <a href="https://github.com/aws/chalice" target="_blank"><strong class="markup--p-strong">AWS Chalice</strong></a>.</p><p id="17ab">2 —<strong class="markup--p-strong"> Periodically</strong>, using a <a href="https://docs.aws.amazon.com/lambda/latest/dg/with-scheduled-events.html" target="_blank"><strong class="markup--p-strong">scheduled Lambda function</strong></a> deployed with <a href="https://serverless.com/" target="_blank"><strong class="markup--p-strong">Serverless</strong></a>.</p><figure id="49a8"><img class="graf-image" src="image01.webp"/><figcaption>Sorry, Rock. Training doesn’t ALWAYS require heavy lifting!</figcaption></figure><h3 id="5781">Training a SageMaker model</h3><p id="ea50">The SageMaker SDK is great when experimenting, but it’s too large to fit in a Lambda package. No worries though: the SageMaker client in <a href="https://boto3.readthedocs.io/" target="_blank"><em class="markup--p-em">boto3</em></a> includes a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/API_CreateTrainingJob.html" target="_blank"><em class="markup--p-em">CreateTrainingJob</em></a> API that will serve our purpose just fine.</p><p id="b81e">The list of parameters may look intimidating, but keep in mind that we’re retraining an existing model. All of these parameters have already been passed: we’ll grab them using the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/API_DescribeTrainingJob.html" target="_blank"><em class="markup--p-em">DescribeTrainingJob</em></a> API and reuse most of them as is, just modifying some of them for extra flexibility.</p><p id="2251">Let’s get to work :)</p><h3 id="b304">Training on-demand with a Chalice web service</h3><blockquote class="graf--blockquote graf--hasDropCapModel" id="cd9f"><a class="markup--blockquote-anchor" href="https://medium.com/@julsimon/using-chalice-to-serve-sagemaker-predictions-a2015c02b033" target="_blank">We’ve used Chalice before</a> to serve SageMaker predictions, so please check out this post if you need a refresher on Chalice.</blockquote><p class="graf-after--blockquote" id="9989">Our web service will provide three APIs:</p><ul class="postList"><li id="a6f1"><strong class="markup--li-strong"><em class="markup--li-em">/list/{results}</em></strong>: list the last <em class="markup--li-em">results</em> training jobs, sorted by descending completion date. We’ll return only the job name and job status, as provided by the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/API_ListTrainingJobs.html" target="_blank"><em class="markup--li-em">ListTrainingJobs</em></a> API.</li><li id="4ac3"><strong class="markup--li-strong"><em class="markup--li-em">/get/{name}</em></strong>: describe a training job. We’ll return the result of the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/API_DescribeTrainingJob.html" target="_blank"><em class="markup--li-em">DescribeTrainingJob</em></a> API.</li><li id="b32a"><strong class="markup--li-strong"><em class="markup--li-em">/train/{name}</em></strong>: retrain a job with <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/API_CreateTrainingJob.html" target="_blank"><em class="markup--li-em">CreateTrainingJob</em></a>. In the request body, we’ll pass a new name (required), an S3 output path to store the model (optional), an instance type (optional) and an instance count (optional).</li></ul><h4 id="d707">Defining IAM permissions</h4><p id="fb15">Chalice is able to auto-generate IAM policies, but it won’t do here. Indeed, we need to add a special permission allowing the Lambda function deployed by Chalice to <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_passrole.html" target="_blank"><strong class="markup--p-strong">pass</strong></a><strong class="markup--p-strong"> the SageMaker service role</strong>.</p><blockquote class="graf--blockquote" id="908e">Rationale: being allowed to call service APIs doesn’t mean that you should have the same permissions as the service itself. To prevent privilege escalation, a user must thus be explicitly allowed to pass the service role, i.e. to inherit the permissions granted to the service.</blockquote><p class="graf-after--blockquote" id="af31">As a consequence, we’ll use the following custom policy: don’t forget to update it with your own account number and role name.</p><figure id="f902"><script src="https://gist.github.com/juliensimon/dc15b05d3cf383940b31998d9dd58742.js"></script></figure><p id="1e9b">This is what the policy should look like in the IAM console.</p><figure id="e5f8"><img class="graf-image" src="image05.webp"/></figure><p id="6d97">Now we’ve got permissions sorted out, let’s start writing our APIs.</p><h4 id="31bc">Listing jobs</h4><p id="fcd2">Nothing fancy here: just call the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/API_ListTrainingJobs.html" target="_blank"><em class="markup--p-em">ListTrainingJobs</em></a> API and return the two fields we’re interested in.</p><figure id="c184"><script src="https://gist.github.com/juliensimon/03f4f59c1e926246ff3dea70f2e60e75.js"></script></figure><blockquote class="graf--blockquote" id="4feb">A note of caution here: when running a service locally, Chalice uses the AWS credentials of the current user, not the policy defined in the configuration file. Take this into account when testing and debugging!</blockquote><h4 class="graf-after--blockquote" id="7871">Describing a job</h4><p id="581b">Super simple. <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/API_DescribeTrainingJob.html" target="_blank"><em class="markup--p-em">DescribeTrainingJob</em></a><em class="markup--p-em"> </em>is all we need.</p><figure id="8e19"><script src="https://gist.github.com/juliensimon/2a24ce913d7cf8c08804e00663ffb041.js"></script></figure><h4 id="b732">Retraining a job</h4><p id="4431">This requires a little more work:</p><ul class="postList"><li id="8031">Describe the <strong class="markup--li-strong">old training job</strong>.</li><li id="1719">Read from the <strong class="markup--li-strong">request body</strong>, set the name for the new training job, as well as the optional new output location, instance type and instance count.</li><li id="0114">Reuse all other <strong class="markup--li-strong">parameters</strong>. <em class="markup--li-em">VpcConfig </em>is causing code duplication, as it cannot be set to an empty dictionary (<a href="https://github.com/boto/boto3/issues/1563" target="_blank">issue created</a>, feel free to +1).</li><li id="6a9d">Train the <strong class="markup--li-strong">new job</strong>.</li><li id="aa3f">Return the <strong class="markup--li-strong">response</strong> from the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/API_CreateTrainingJob.html" target="_blank"><em class="markup--li-em">CreateTrainingJobAPI</em></a>.</li></ul><figure id="b237"><script src="https://gist.github.com/juliensimon/50ff74d5cbbdcf826c824d8bcf0f09fa.js"></script></figure><p id="5a0d">Let’s deploy our service and test!</p><figure id="240f"><script src="https://gist.github.com/juliensimon/73777a36b31e63bfd4db82bb55b33f56.js"></script></figure><p id="d315">All right, this works! Now we have <strong class="markup--p-strong">a simple way to retrain any SageMaker job on demand</strong> with new parameters (<a href="https://github.com/juliensimon/aws/tree/master/lambda_frameworks/chalice/sagemakertrainer" target="_blank">code on Github</a>).</p><p id="0359">What if we needed to retrain according to a specific <strong class="markup--p-strong">schedule</strong>? Don’t you go writing <em class="markup--p-em">cron</em> jobs deployed on on EC2 instance! There is a much better way :)</p><h3 id="6b23">Training periodically with a scheduled Lambda</h3><p id="a425">Lambda functions can be triggered by all kinds of different events. One of them is <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/WhatIsCloudWatchEvents.html" target="_blank"><strong class="markup--p-strong">CloudWatch Events</strong></a>, which let us <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/RunLambdaSchedule.html" target="_blank">schedule the execution of a Lambda function</a> at periodic intervals.</p><p id="210d">Of course, we could set everything up with AWS APIs, but when it comes to deploying Lambda functions, one of the simpler ways is to use the now well-known <a href="https://serverless.com/" target="_blank"><strong class="markup--p-strong">Serverless framework</strong></a>.</p><h4 id="570b">Configuring the Lambda function</h4><p id="1759">The <a href="https://serverless.com/framework/docs/providers/aws/guide/functions/" target="_blank">configuration</a> is straightforward:</p><ul class="postList"><li id="e90f">Define <strong class="markup--li-strong">permissions</strong>. No need to worry about CloudWatch Logs permissions, they are added automatically. Make sure you use the same service role that was used to train the initial job.</li><li id="6baf">Define a <strong class="markup--li-strong">function</strong> named ‘main’.</li><li id="b54c">Define a <strong class="markup--li-strong">event source</strong> with a rate of 5 minutes (*** this is for testing purposes only: please change this! ***). We could also use a <a href="https://docs.aws.amazon.com/lambda/latest/dg/tutorial-scheduled-events-schedule-expressions.html" target="_blank"><em class="markup--li-em">cron</em> expression</a>.</li><li id="de49">Define <strong class="markup--li-strong">environment variables</strong> storing the <strong class="markup--li-strong">name of the old job</strong>, a <strong class="markup--li-strong">name prefix for the new job</strong>, the <strong class="markup--li-strong">instance type</strong> and the <strong class="markup--li-strong">instance count</strong>. This will provide initial values for new trainings, which can be updated at any time in the console or with the <a href="https://docs.aws.amazon.com/lambda/latest/dg/API_UpdateFunctionConfiguration.html" target="_blank"><em class="markup--li-em">UpdateFunctionConfiguration</em></a> API.</li></ul><figure id="992d"><script src="https://gist.github.com/juliensimon/e4b4fcd87a8e6c9d54ea2fd6d1afabbc.js"></script></figure><h4 id="70d5">Writing the Lambda function</h4><p id="20f4">We can reuse the code written for our Chalice service. The main difference is of course that we’re now reading parameters from <strong class="markup--p-strong">environment variables</strong>.</p><p id="34a1">As this should be able to run many times, we’ll use the prefix to build a different name for each new job.</p><figure id="2bdf"><script src="https://gist.github.com/juliensimon/8ea9331ec3b8e7b925c9e2ba36422213.js"></script></figure><h4 id="4917">Deploying the Lambda function</h4><p id="e50c">Just like for Chalice, a single CLI command is all it takes.</p><figure id="5e8e"><script src="https://gist.github.com/juliensimon/4bca94d1db11e3faf1907c827507a98b.js"></script></figure><p id="3ddc">We can check our function in the Lambda console.</p><figure id="0fa2"><img class="graf-image" src="image04.webp"/></figure><p id="52e7">The environment variables are visible too.</p><figure id="76f2"><img class="graf-image" src="image03.webp"/></figure><p id="7476">Everything looks fine. A few minutes later, training jobs start to appear in the SageMaker console. Hurrah!</p><figure id="2fce"><img class="graf-image" src="image02.webp"/></figure><p id="2a1e">We now have a <strong class="markup--p-strong">completely automated way to retrain SageMaker models</strong> (<a href="https://github.com/juliensimon/aws/tree/master/lambda_frameworks/serverless/sagemakerscheduler" target="_blank">code on Github</a>). If we wanted to retrain different models, we would simply deploy additional Lambda functions with different parameters.</p><h3 id="2d72">Conclusion</h3><p id="5518">With <strong class="markup--p-strong">just a few lines of code</strong>, we built two different solutions to retrain SageMaker models and we deployed each with <strong class="markup--p-strong">one single command</strong>. Both solutions are <strong class="markup--p-strong">simple</strong>, <strong class="markup--p-strong">reliable</strong>, <strong class="markup--p-strong">scalable</strong>… and have <strong class="markup--p-strong">pretty much zero cost</strong>. What’s not to like? I guess Serverless ML Ops are a thing, then :*)</p><p id="15c5">That’s it for today. Thank you for reading, happy to answer questions here or on <a href="https://twitter.com/julsimon" target="_blank">Twitter</a>.</p><p id="cd3c">For more content, please feel free to check out my <a href="https://www.youtube.com/juliensimonfr" target="_blank">YouTube channel</a>.</p></div></div></section><section class="section"><div><hr/></div><div><div><p id="2d3d"><em class="markup--p-em">AWS at Eurovision :D Guitars and fire!</em></p><figure id="7279"><iframe frameborder="0" height="393" scrolling="no" src="https://www.youtube.com/embed/p6e1TmYb33w?feature=oembed" width="700"></iframe></figure></div></div></section>
</section>
</article></body></html>
