<!DOCTYPE html>

<html><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"/><title>Mastering the mystical art of model deployment, part 2: deploying Amazon SageMaker endpoints with…</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<section class="e-content" data-field="body">
<section class="section"><div><hr/></div><div><div><h3 id="e47a">Mastering the mystical art of model deployment, part 2: deploying Amazon SageMaker endpoints with AWS CloudFormation</h3><p id="5ff0">In a previous <a href="https://medium.com/@julsimon/mastering-the-mystical-art-of-model-deployment-c0cafe011175" target="_blank">article</a>, I discussed several deployment strategies for machine learning models, and I showed you how to use the <a href="http://aws.amazon.com/sagemaker" target="_blank">SageMaker</a> <a href="https://github.com/aws/sagemaker-python-sdk" target="_blank">SDK</a> to deploy several models on the same prediction endpoint.</p><p id="217a">This is all fine and dandy, but in a production setting, I’d bet that most of you would prefer <strong class="markup--p-strong">automating</strong> this properly with <a href="http://aws.amazon.com/cloudformation" target="_blank">CloudFormation</a>. One-click deployment, automatic clean-up and more: what’s not to like?</p><p id="b585">In this post, I’ll show you how to:</p><ul class="postList"><li id="1dac"><strong class="markup--li-strong">deploy a SageMaker endpoint backed by a single model</strong>,</li><li id="32ef"><strong class="markup--li-strong">scale the endpoint by adding more instances,</strong></li><li id="0f45"><strong class="markup--li-strong">add an extra production variant to the endpoint</strong>, i.e. add a second model to the endpoint and set up weighted round-robin,</li><li id="26c2"><strong class="markup--li-strong">do things The-Right-Way</strong>, with nice YAML <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/gettingstarted.templatebasics.html" target="_blank">templates</a> and <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-updating-stacks-changesets.html" target="_blank">change sets</a>.</li></ul><blockquote class="graf--blockquote" id="c7dd">As usual, all code is available on <a class="markup--blockquote-anchor" href="https://gitlab.com/juliensimon/sagemaker-automation/tree/master/cloudformation" target="_blank">Gitlab</a>.</blockquote><p class="graf-after--blockquote" id="2891">Alright, magic time!</p><figure id="06ce"><img class="graf-image" src="image02.webp"/><figcaption>And this, my friend, is how you deploy two production variants.</figcaption></figure><h3 id="5591">Deploying a SageMaker endpoint</h3><p id="66e4">First, let’s write a template that lets us deploy a single model. We need to create Cloudformation resources for the <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-sagemaker-model.html" target="_blank">model</a>, the <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-sagemaker-endpointconfig.html" target="_blank">endpoint configuration</a> and the <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-sagemaker-endpoint.html" target="_blank">endpoint</a> itself. I’ve tried to keep the template as straightforward as possible, and it should work with any single-container model</p><blockquote class="graf--blockquote" id="34d0">For <a class="markup--blockquote-anchor" href="https://docs.aws.amazon.com/sagemaker/latest/dg/inference-pipelines.html" target="_blank">inference pipelines</a>, you’ll have to list all containers in the Model resource.</blockquote><figure class="graf-after--blockquote" id="358b"><script src="https://gist.github.com/juliensimon/bebdcb1f9755ec46411213fd1b239d59.js"></script></figure><p id="a1c9">As you can see, we’ll need to pass the container name, the location of the model artefact, and the role as parameters. These strings are not user-friendly, and it would be nicer to work with the training job name.</p><p id="c75b">A bit of Python will help us with that. Thanks to the SageMaker SDK, we can easily describe a training job, extract the values we need and use them to create our stack.</p><figure id="d52a"><script src="https://gist.github.com/juliensimon/cff850677c3d8f43cb1979e902da1ae4.js"></script></figure><p id="66bf">All right, let’s run this.</p><pre class="graf--pre" id="6d99">$ python create-stack.py<br/>xgboost-2019-05-09-15-20-51-276<br/>{u'StackId': 'arn:aws:cloudformation:eu-west-1:123456789012:stack/endpoint-one-model/06661d80-78b5-11e9-9878-066324f10f26', 'ResponseMetadata': {'RetryAttempts': 0, 'HTTPStatusCode': 200, 'RequestId': '065e0749-78b5-11e9-a5d5-af6ed726348b', 'HTTPHeaders': {'x-amzn-requestid': '065e0749-78b5-11e9-a5d5-af6ed726348b', 'date': 'Fri, 17 May 2019 15:04:09 GMT', 'content-length': '388', 'content-type': 'text/xml'}}}</pre><p class="graf-after--pre" id="f1a0">Meh. Let’s take a look at the Cloudformation console.</p><figure id="45de"><img class="graf-image" src="image05.webp"/></figure><p id="8639">Pretty much what we expected: first create the model (i.e. “register” the model artifact in S3 as something that can be deployed), then the endpoint configuration, and finally the endpoint.</p><p id="534f">After a few minutes, the endpoint is in service and visible in the SageMaker console. Woohoo.</p><figure id="9a46"><img class="graf-image" src="image01.webp"/></figure><h4 id="41ef">Updating the endpoint configuration</h4><p id="794a">Now, let’s say we’d like to add a second instance to this endpoint. Now, don’t you start clicking in the console, ya hear me? This would introduce drift in the stack we just created, and we don’t like that around here.</p><p id="17b5">Instead, let’s define a <strong class="markup--p-strong">change set</strong>, and check its impact before executing it... which is how battle-scarred veterans manage production systems ;) I’m using the CLI (because), feel free to use your favorite language SDK if that works better for you.</p><pre class="graf--pre" id="3424">$ aws cloudformation create-change-set \<br/>--stack-name endpoint-one-model \<br/>--change-set-name add-instances \<br/>--use-previous-template \<br/>--parameters ParameterKey="InstanceCount",ParameterValue="2" \<br/>             ParameterKey=ModelName,UsePreviousValue=true \<br/>             ParameterKey="ModelDataUrl",UsePreviousValue=true \<br/>             ParameterKey="TrainingImage",UsePreviousValue=true \<br/>             ParameterKey="RoleArn",UsePreviousValue=true</pre><p class="graf-after--pre" id="92ab">Basically, we’re telling Cloudformation: “<em class="markup--p-em">hey, I’d like to use the same template with the same parameters as before, except that I want two instances now. Tell me what’s going to happen</em>”.</p><p id="577e">No change is applied at this stage. We could call ‘<em class="markup--p-em">aws cloudformation describe-change-set</em>’ to see what’s going to happen, or we can look at a console for a nicer experience.</p><figure id="1efa"><img class="graf-image" src="image11.webp"/></figure><p id="6675">The instance count is defined in the endpoint configuration, which is itself associated to the endpoint, so it makes sense that both resources need to be updated. The harder question is: do they need to be replaced, and will the endpoint go down? ‘<em class="markup--p-em">Conditional</em>’ basically means ‘It depends’ (or ‘Roll a dice’ if you feel sarcastic). At this point, you would need to look at the Cloudformation documentation for these resources, and probably at the SageMaker documentation as well.</p><blockquote class="graf--pullquote" id="5579"><strong class="markup--pullquote-strong">In a production environment, getting this right is the difference between an invisible change and downtime, so RTFM</strong>.</blockquote><p class="graf-after--pullquote" id="cd57">I’ll save you the trouble (this time): the endpoint will not be taken down. A new endpoint configuration will be created, and applied to the endpoint without any downtime.</p><p id="6d24">OK, now that we feel good about this change, let’s apply it.</p><pre class="graf--pre" id="b677">$ aws cloudformation execute-change-set \<br/>--change-set-name add-instances \<br/>--stack-name endpoint-one-model</pre><p class="graf-after--pre" id="78da">Done. Pretty quickly, we see the endpoint going into the ‘<em class="markup--p-em">Updating</em>’ status in the SageMaker console.</p><figure id="be40"><img class="graf-image" src="image12.webp"/></figure><p id="35a9">A few minutes later, the change set has been fully applied, and the Cloudformation console tells us the full story: a new endpoint configuration was created and applied to the endpoint.</p><figure id="6006"><img class="graf-image" src="image06.webp"/></figure><p id="e2eb">Let’s take a quick look at the SageMaker console. Yup: the endpoint is ‘<em class="markup--p-em">Active</em>’ again, and it’s backed by two instances.</p><figure id="a880"><img class="graf-image" src="image10.webp"/></figure><p id="db6a">Pretty cool. Now let’s take things up a notch, and add a second model to the endpoint.</p><h3 id="7cc8">Adding a second model to the endpoint</h3><p id="29a2">Let’s say we’d like to use <strong class="markup--p-strong">canary deployment</strong> to test a new model on the endpoint, starting with a fraction of live traffic and gradually increasing it to 100% (or rolling back…). In SageMaker terms, we need to create a second <strong class="markup--p-strong">production variant </strong>running the new model.</p><p id="5ec1">Here’s the updated template. We’re simply adding a <strong class="markup--p-strong">second <em class="markup--p-em">Model</em> resource</strong>, as well as a <strong class="markup--p-strong">second production variant in the <em class="markup--p-em">EndpointConfig</em> resource</strong>. This second variant will get a third of the traffic (0.5/(1+0.5), meaning that the first one will get two thirds (1/1+0.5).</p><blockquote class="graf--blockquote" id="9caf">In a real production setting, we would certainly start lower (say, 10%) and gradually increase that number.</blockquote><figure class="graf-after--blockquote" id="6c55"><script src="https://gist.github.com/juliensimon/a51de96cdfc0d9571fb66d2e6a17a78b.js"></script></figure><p id="3d26">Here, I’d like to deploy another XGBoost model trained with the same container. If you want to use a model trained with another container, simply add another parameter, e.g. <em class="markup--p-em">TrainingImage2</em>.</p><p id="937a">Let’s create a change set. This time, we’re using an updated template, so we need to pass its location.</p><pre class="graf--pre" id="5551">$ export MODEL2_NAME="xgboost-190509-1528-016-39860b48"</pre><pre class="graf--pre graf-after--pre" id="fa01">$ export MODEL2_ARTEFACT=""s3://sagemaker-eu-west-1-123456789012/sagemaker/DEMO-hpo-xgboost-dm/output/xgboost-190509-1528-016-39860b48/output/model.tar.gz"</pre><pre class="graf--pre graf-after--pre" id="92f2">$ aws cloudformation create-change-set \<br/>--stack-name endpoint-one-model \<br/>--change-set-name add-production-variant \<br/>--template-body "file://endpoint-two-models.yml" \<br/>--parameters \<br/>   ParameterKey=ModelName2,ParameterValue=$MODEL2_NAME \<br/>   ParameterKey="ModelDataUrl2",ParameterValue=$MODEL2_ARTEFACT \<br/>   ParameterKey=ModelName,UsePreviousValue=true \<br/>   ParameterKey="ModelDataUrl",UsePreviousValue=true \<br/>   ParameterKey="TrainingImage",UsePreviousValue=true \<br/>   ParameterKey="RoleArn",UsePreviousValue=true</pre><p class="graf-after--pre" id="edee">Let’s check the impact in the console.</p><figure id="6927"><img class="graf-image" src="image07.webp"/></figure><p id="c5c8">Cloudformation will create a new model, and then a new endpoint configuration which will be applied to the endpoint. Here too, the endpoint will stay up during the whole process.</p><p id="c471">Let’s execute the change set.</p><pre class="graf--pre" id="a402">$ aws cloudformation execute-change-set --change-set-name add-production-variant --stack-name endpoint-one-model</pre><p class="graf-after--pre" id="6da4">Once again, the Cloudformation console displays the updates to the stack</p><figure id="1c69"><img class="graf-image" src="image09.webp"/></figure><p id="3f16">After a few minutes, the update is complete. The SageMaker console confirms that the endpoint is ‘<em class="markup--p-em">Active</em>’, and that it’s now running two production variants. Note that <em class="markup--p-em">variant-1</em> uses a single instance again, as defined in our updated template.</p><figure id="a176"><img class="graf-image" src="image03.webp"/></figure><figure id="16c8"><img class="graf-image" src="image04.webp"/></figure><p id="639c">Once we’re satisfied that the model works as intended, we can update the stack again to shift all trafic to <em class="markup--p-em">variant-2.</em></p><h3 id="24bc">Cleaning up</h3><p id="fd54">What if we want to take this endpoint down? Super easy: just delete the stack, and Cloudformation will clean everything up automatically.</p><blockquote class="graf--blockquote" id="a32c">Careful with the ‘Delete Stack’ API: no confirmation will be asked for! Many DevOps engineers have learned this a bit too late… Needless to say, the AWS world breathed a sigh of relief when <a class="markup--blockquote-anchor" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-protect-stacks.html" target="_blank">stack termination protection</a> was introduced :)</blockquote><pre class="graf--pre graf-after--blockquote" id="3192">$ aws cloudformation delete-stack --stack-name endpoint-one-model</pre><h3 class="graf-after--pre" id="39c4">Conclusion</h3><p id="58bc">As you can see, you can easily build safe and automated deployment workflows for SageMaker endpoints. Sure, the SageMaker SDK is great for development and testing, but when it comes to production, I don’t think you can beat the predictability and robustness of Cloudformation.</p><p id="5c10">As always, thank you very much for reading. Happy to answer questions here or on <a href="https://twitter.com/julsimon" target="_blank">Twitter</a>.</p></div></div></section><section class="section"><div><hr/></div><div><div><p id="3614"><em class="markup--p-em">Come, come to the Sabbath, let’s deploy Machine Learning models ;)</em></p><figure id="0580"><iframe frameborder="0" height="393" scrolling="no" src="https://www.youtube.com/embed/ou7skBJ8rno?feature=oembed" width="700"></iframe></figure><figure id="1ef4"><img class="graf-image" src="image13.webp"/></figure><p id="9b5e"><strong class="markup--p-strong">Follow us on </strong><a href="https://twitter.com/joinfaun" target="_blank"><strong class="markup--p-strong">Twitter</strong></a><strong class="markup--p-strong"> </strong>🐦<strong class="markup--p-strong"> and </strong><a href="https://www.facebook.com/faun.dev/" target="_blank"><strong class="markup--p-strong">Facebook</strong></a><strong class="markup--p-strong"> </strong>👥<strong class="markup--p-strong"> and join our </strong><a href="https://www.facebook.com/groups/364904580892967/" target="_blank"><strong class="markup--p-strong">Facebook Group</strong></a><strong class="markup--p-strong"> </strong>💬<strong class="markup--p-strong">.</strong></p><p id="c972"><strong class="markup--p-strong">To join our community Slack </strong>🗣️ <strong class="markup--p-strong">and read our weekly Faun topics </strong>🗞️,<strong class="markup--p-strong"> click here⬇</strong></p></div><div><figure id="83d1"><a href="https://www.faun.dev/join/?utm_source=medium.com%2Ffaun&amp;utm_medium=medium&amp;utm_campaign=faunmediumbanner" target="_blank"><img class="graf-image" src="image08.webp"/></a></figure></div><div><h4 id="3062">If this post was helpful, please click the clap 👏 button below a few times to show your support for the author! ⬇</h4></div></div></section>
</section>
</article></body></html>
